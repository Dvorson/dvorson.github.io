<!DOCTYPE html><html lang="en"> <head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="description" content="Anton Dvorson - Solution and software architect with 10+ years experience designing high-traffic e-commerce, media, and digital manufacturing platforms."><title>E-commerce Platform Architecture: Building Scalable Online Commerce Solutions</title><!-- Fonts --><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet"><!-- Icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer"><!-- KaTeX for math formatting if needed --><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css" integrity="sha384-GvrOXuhMATgEsSwCs4smul74iXGOixntILdUW9XmUC6+HX0sLNAK3q71HotJqlAn" crossorigin="anonymous"><!-- Favicon --><link rel="icon" type="image/svg+xml" href="/favicon.svg"><link rel="stylesheet" href="/_astro/_slug_.BJWYzgPO.css"></head> <body class="min-h-screen flex flex-col bg-gray-50"> <!-- Navigation --> <nav class="bg-white py-4 border-b border-gray-100 sticky top-0 z-10 shadow-sm"> <div class="container mx-auto flex items-center justify-between"> <a href="/" class="text-xl font-bold text-gradient">Anton Dvorson</a> <div class="flex items-center space-x-6"> <a href="/" class="text-gray-600 hover:text-indigo-600 transition-colors font-medium">Home</a> <a href="/categories" class="text-gray-600 hover:text-indigo-600 transition-colors font-medium">Categories</a> <a href="/tags" class="text-gray-600 hover:text-indigo-600 transition-colors font-medium">Tags</a> <a href="https://github.com/dvorson" class="text-gray-600 hover:text-indigo-600 transition-colors" target="_blank" rel="noopener noreferrer"> <i class="fab fa-github text-lg"></i> </a> </div> </div> </nav> <!-- Main Content --> <main class="flex-grow container py-8">  <article class="max-w-4xl mx-auto my-12"> <!-- Article Header --> <header class="mb-12 bg-white rounded-2xl p-8 shadow-sm border border-gray-100"> <div class="max-w-3xl"> <h1 class="text-4xl sm:text-5xl font-bold mb-6 text-gray-900 leading-tight">E-commerce Platform Architecture: Building Scalable Online Commerce Solutions</h1> <div class="flex flex-wrap items-center gap-4 text-gray-600 mb-6"> <time class="flex items-center text-sm font-medium"> <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"> <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path> </svg> Invalid Date </time>  </div> <p class="text-lg text-gray-700 leading-relaxed mb-6 font-medium">Complete guide to e-commerce platform architecture and development. Learn microservices patterns, payment processing, inventory management, and performance optimization for high-traffic online stores.</p> <div class="flex flex-wrap gap-2"> <a href="/tags/E-commerce Architecture" class="inline-flex items-center px-3 py-1.5 bg-blue-50 text-blue-700 rounded-full text-sm font-medium hover:bg-blue-100 transition-all duration-200 border border-blue-200 hover:border-blue-300"> <span class="text-xs mr-1">#</span> E-commerce Architecture </a><a href="/tags/Microservices" class="inline-flex items-center px-3 py-1.5 bg-blue-50 text-blue-700 rounded-full text-sm font-medium hover:bg-blue-100 transition-all duration-200 border border-blue-200 hover:border-blue-300"> <span class="text-xs mr-1">#</span> Microservices </a><a href="/tags/Payment Processing" class="inline-flex items-center px-3 py-1.5 bg-blue-50 text-blue-700 rounded-full text-sm font-medium hover:bg-blue-100 transition-all duration-200 border border-blue-200 hover:border-blue-300"> <span class="text-xs mr-1">#</span> Payment Processing </a><a href="/tags/Online Commerce" class="inline-flex items-center px-3 py-1.5 bg-blue-50 text-blue-700 rounded-full text-sm font-medium hover:bg-blue-100 transition-all duration-200 border border-blue-200 hover:border-blue-300"> <span class="text-xs mr-1">#</span> Online Commerce </a><a href="/tags/Scalable Systems" class="inline-flex items-center px-3 py-1.5 bg-blue-50 text-blue-700 rounded-full text-sm font-medium hover:bg-blue-100 transition-all duration-200 border border-blue-200 hover:border-blue-300"> <span class="text-xs mr-1">#</span> Scalable Systems </a><a href="/tags/Node.js" class="inline-flex items-center px-3 py-1.5 bg-blue-50 text-blue-700 rounded-full text-sm font-medium hover:bg-blue-100 transition-all duration-200 border border-blue-200 hover:border-blue-300"> <span class="text-xs mr-1">#</span> Node.js </a><a href="/tags/React" class="inline-flex items-center px-3 py-1.5 bg-blue-50 text-blue-700 rounded-full text-sm font-medium hover:bg-blue-100 transition-all duration-200 border border-blue-200 hover:border-blue-300"> <span class="text-xs mr-1">#</span> React </a><a href="/tags/Enterprise Software" class="inline-flex items-center px-3 py-1.5 bg-blue-50 text-blue-700 rounded-full text-sm font-medium hover:bg-blue-100 transition-all duration-200 border border-blue-200 hover:border-blue-300"> <span class="text-xs mr-1">#</span> Enterprise Software </a> </div> </div> </header> <!-- Article Content --> <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden"> <div class="p-8 sm:p-12"> <div class="prose prose-lg prose-gray max-w-none prose-headings:text-gray-900 prose-headings:font-bold prose-h1:text-3xl prose-h1:mb-8 prose-h1:pb-4 prose-h1:border-b prose-h1:border-gray-200 prose-h2:text-2xl prose-h2:mt-12 prose-h2:mb-6 prose-h3:text-xl prose-h3:mt-8 prose-h3:mb-4 prose-p:text-gray-700 prose-p:leading-relaxed prose-p:mb-6 prose-a:text-blue-600 prose-a:no-underline hover:prose-a:text-blue-700 hover:prose-a:underline prose-strong:text-gray-900 prose-strong:font-semibold prose-code:text-pink-600 prose-code:bg-gray-100 prose-code:px-1.5 prose-code:py-0.5 prose-code:rounded prose-code:text-sm prose-code:font-medium prose-pre:bg-gray-900 prose-pre:text-gray-100 prose-pre:rounded-xl prose-pre:p-6 prose-pre:overflow-x-auto prose-blockquote:border-l-4 prose-blockquote:border-blue-500 prose-blockquote:bg-blue-50 prose-blockquote:p-6 prose-blockquote:rounded-r-lg prose-blockquote:my-8 prose-ul:space-y-2 prose-ol:space-y-2 prose-li:text-gray-700 prose-table:border-collapse prose-table:border prose-table:border-gray-300 prose-th:border prose-th:border-gray-300 prose-th:bg-gray-50 prose-th:px-4 prose-th:py-2 prose-th:font-semibold prose-td:border prose-td:border-gray-300 prose-td:px-4 prose-td:py-2 prose-img:rounded-xl prose-img:shadow-md prose-img:mx-auto"> <h1 id="e-commerce-platform-architecture-building-scalable-online-commerce-solutions">E-commerce Platform Architecture: Building Scalable Online Commerce Solutions</h1>
<p>Building successful e-commerce platforms requires careful architectural planning to handle complex business logic, high traffic volumes, and stringent security requirements. Through my work on the KDI-HEAD e-commerce platform at EPAM Systems and the heavy equipment marketplace at FirstLine Software, Iâ€™ve developed proven approaches for creating scalable, maintainable commerce solutions.</p>
<h2 id="the-e-commerce-architecture-challenge">The E-commerce Architecture Challenge</h2>
<p>Modern e-commerce platforms must balance numerous competing requirements:</p>
<ul>
<li><strong>High Availability</strong>: 99.9%+ uptime during peak shopping periods</li>
<li><strong>Performance</strong>: Sub-second page loads even under heavy traffic</li>
<li><strong>Security</strong>: PCI DSS compliance and protection of customer data</li>
<li><strong>Scalability</strong>: Handle traffic spikes during sales events and seasonal peaks</li>
<li><strong>Global Reach</strong>: Multi-region deployment with localized experiences</li>
<li><strong>Integration Complexity</strong>: Connect with payment processors, inventory systems, shipping providers, and marketing tools</li>
</ul>
<p>During my work on the KDI-HEAD platform, we successfully handled traffic spikes of 10x normal volume during promotional campaigns while maintaining consistent performance and zero downtime.</p>
<h2 id="core-e-commerce-architecture-patterns">Core E-commerce Architecture Patterns</h2>
<h3 id="1-microservices-based-commerce-architecture">1. Microservices-Based Commerce Architecture</h3>
<p>Breaking e-commerce functionality into focused services enables independent scaling and development.</p>
<p><strong>Service Decomposition Strategy</strong></p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="typescript"><code><span class="line"><span style="color:#6A737D">// Core e-commerce services architecture</span></span>
<span class="line"><span style="color:#F97583">interface</span><span style="color:#B392F0"> EcommerceService</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#FFAB70">  name</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#FFAB70">  responsibilities</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">[];</span></span>
<span class="line"><span style="color:#FFAB70">  dependencies</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">[];</span></span>
<span class="line"><span style="color:#FFAB70">  dataStore</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#FFAB70">  scalingStrategy</span><span style="color:#F97583">:</span><span style="color:#9ECBFF"> 'horizontal'</span><span style="color:#F97583"> |</span><span style="color:#9ECBFF"> 'vertical'</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">const</span><span style="color:#79B8FF"> ECOMMERCE_SERVICES</span><span style="color:#F97583">:</span><span style="color:#B392F0"> EcommerceService</span><span style="color:#E1E4E8">[] </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> [</span></span>
<span class="line"><span style="color:#E1E4E8">  {</span></span>
<span class="line"><span style="color:#E1E4E8">    name: </span><span style="color:#9ECBFF">'Product Catalog Service'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    responsibilities: [</span></span>
<span class="line"><span style="color:#9ECBFF">      'Product information management'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">      'Category hierarchy'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">      'Search and filtering'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">      'Product recommendations'</span></span>
<span class="line"><span style="color:#E1E4E8">    ],</span></span>
<span class="line"><span style="color:#E1E4E8">    dependencies: [</span><span style="color:#9ECBFF">'Inventory Service'</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'Pricing Service'</span><span style="color:#E1E4E8">],</span></span>
<span class="line"><span style="color:#E1E4E8">    dataStore: </span><span style="color:#9ECBFF">'Elasticsearch + PostgreSQL'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    scalingStrategy: </span><span style="color:#9ECBFF">'horizontal'</span></span>
<span class="line"><span style="color:#E1E4E8">  },</span></span>
<span class="line"><span style="color:#E1E4E8">  {</span></span>
<span class="line"><span style="color:#E1E4E8">    name: </span><span style="color:#9ECBFF">'User Management Service'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    responsibilities: [</span></span>
<span class="line"><span style="color:#9ECBFF">      'User registration and authentication'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">      'Profile management'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">      'Address book'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">      'Preferences and wishlist'</span></span>
<span class="line"><span style="color:#E1E4E8">    ],</span></span>
<span class="line"><span style="color:#E1E4E8">    dependencies: [</span><span style="color:#9ECBFF">'Notification Service'</span><span style="color:#E1E4E8">],</span></span>
<span class="line"><span style="color:#E1E4E8">    dataStore: </span><span style="color:#9ECBFF">'PostgreSQL'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    scalingStrategy: </span><span style="color:#9ECBFF">'horizontal'</span></span>
<span class="line"><span style="color:#E1E4E8">  },</span></span>
<span class="line"><span style="color:#E1E4E8">  {</span></span>
<span class="line"><span style="color:#E1E4E8">    name: </span><span style="color:#9ECBFF">'Shopping Cart Service'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    responsibilities: [</span></span>
<span class="line"><span style="color:#9ECBFF">      'Cart state management'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">      'Session handling'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">      'Cart persistence'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">      'Cart abandonment tracking'</span></span>
<span class="line"><span style="color:#E1E4E8">    ],</span></span>
<span class="line"><span style="color:#E1E4E8">    dependencies: [</span><span style="color:#9ECBFF">'Product Catalog Service'</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'Pricing Service'</span><span style="color:#E1E4E8">],</span></span>
<span class="line"><span style="color:#E1E4E8">    dataStore: </span><span style="color:#9ECBFF">'Redis + PostgreSQL'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    scalingStrategy: </span><span style="color:#9ECBFF">'horizontal'</span></span>
<span class="line"><span style="color:#E1E4E8">  },</span></span>
<span class="line"><span style="color:#E1E4E8">  {</span></span>
<span class="line"><span style="color:#E1E4E8">    name: </span><span style="color:#9ECBFF">'Order Management Service'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    responsibilities: [</span></span>
<span class="line"><span style="color:#9ECBFF">      'Order creation and processing'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">      'Order status tracking'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">      'Order history'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">      'Return and refund processing'</span></span>
<span class="line"><span style="color:#E1E4E8">    ],</span></span>
<span class="line"><span style="color:#E1E4E8">    dependencies: [</span><span style="color:#9ECBFF">'Payment Service'</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'Inventory Service'</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'Shipping Service'</span><span style="color:#E1E4E8">],</span></span>
<span class="line"><span style="color:#E1E4E8">    dataStore: </span><span style="color:#9ECBFF">'PostgreSQL'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    scalingStrategy: </span><span style="color:#9ECBFF">'vertical'</span></span>
<span class="line"><span style="color:#E1E4E8">  },</span></span>
<span class="line"><span style="color:#E1E4E8">  {</span></span>
<span class="line"><span style="color:#E1E4E8">    name: </span><span style="color:#9ECBFF">'Payment Service'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    responsibilities: [</span></span>
<span class="line"><span style="color:#9ECBFF">      'Payment processing'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">      'Payment method management'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">      'Transaction history'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">      'Fraud detection integration'</span></span>
<span class="line"><span style="color:#E1E4E8">    ],</span></span>
<span class="line"><span style="color:#E1E4E8">    dependencies: [</span><span style="color:#9ECBFF">'User Management Service'</span><span style="color:#E1E4E8">],</span></span>
<span class="line"><span style="color:#E1E4E8">    dataStore: </span><span style="color:#9ECBFF">'PostgreSQL (encrypted)'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    scalingStrategy: </span><span style="color:#9ECBFF">'vertical'</span></span>
<span class="line"><span style="color:#E1E4E8">  },</span></span>
<span class="line"><span style="color:#E1E4E8">  {</span></span>
<span class="line"><span style="color:#E1E4E8">    name: </span><span style="color:#9ECBFF">'Inventory Service'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    responsibilities: [</span></span>
<span class="line"><span style="color:#9ECBFF">      'Stock level management'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">      'Reservation handling'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">      'Inventory tracking'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">      'Supplier integration'</span></span>
<span class="line"><span style="color:#E1E4E8">    ],</span></span>
<span class="line"><span style="color:#E1E4E8">    dependencies: [],</span></span>
<span class="line"><span style="color:#E1E4E8">    dataStore: </span><span style="color:#9ECBFF">'PostgreSQL'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    scalingStrategy: </span><span style="color:#9ECBFF">'horizontal'</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"><span style="color:#E1E4E8">];</span></span>
<span class="line"></span></code></pre>
<p><strong>Service Communication Patterns</strong></p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="typescript"><code><span class="line"><span style="color:#6A737D">// Event-driven communication between services</span></span>
<span class="line"><span style="color:#F97583">interface</span><span style="color:#B392F0"> DomainEvent</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#FFAB70">  eventId</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#FFAB70">  eventType</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#FFAB70">  aggregateId</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#FFAB70">  aggregateType</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#FFAB70">  eventData</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> any</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#FFAB70">  timestamp</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Date</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#FFAB70">  version</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> number</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">class</span><span style="color:#B392F0"> EventBus</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">  private</span><span style="color:#FFAB70"> handlers</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Map</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#79B8FF">string</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">Function</span><span style="color:#E1E4E8">[]> </span><span style="color:#F97583">=</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> Map</span><span style="color:#E1E4E8">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">  publish</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">event</span><span style="color:#F97583">:</span><span style="color:#B392F0"> DomainEvent</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> void</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> handlers</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.handlers.</span><span style="color:#B392F0">get</span><span style="color:#E1E4E8">(event.eventType) </span><span style="color:#F97583">||</span><span style="color:#E1E4E8"> [];</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#E1E4E8">    handlers.</span><span style="color:#B392F0">forEach</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">handler</span><span style="color:#F97583"> =></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">      try</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#B392F0">        handler</span><span style="color:#E1E4E8">(event);</span></span>
<span class="line"><span style="color:#E1E4E8">      } </span><span style="color:#F97583">catch</span><span style="color:#E1E4E8"> (error) {</span></span>
<span class="line"><span style="color:#E1E4E8">        console.</span><span style="color:#B392F0">error</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">`Error handling event ${</span><span style="color:#E1E4E8">event</span><span style="color:#9ECBFF">.</span><span style="color:#E1E4E8">eventType</span><span style="color:#9ECBFF">}:`</span><span style="color:#E1E4E8">, error);</span></span>
<span class="line"><span style="color:#6A737D">        // Implement dead letter queue for failed events</span></span>
<span class="line"><span style="color:#79B8FF">        this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">sendToDeadLetterQueue</span><span style="color:#E1E4E8">(event, error);</span></span>
<span class="line"><span style="color:#E1E4E8">      }</span></span>
<span class="line"><span style="color:#E1E4E8">    });</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">  subscribe</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">eventType</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">handler</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Function</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> void</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">!</span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.handlers.</span><span style="color:#B392F0">has</span><span style="color:#E1E4E8">(eventType)) {</span></span>
<span class="line"><span style="color:#79B8FF">      this</span><span style="color:#E1E4E8">.handlers.</span><span style="color:#B392F0">set</span><span style="color:#E1E4E8">(eventType, []);</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#79B8FF">    this</span><span style="color:#E1E4E8">.handlers.</span><span style="color:#B392F0">get</span><span style="color:#E1E4E8">(eventType)</span><span style="color:#F97583">!</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">push</span><span style="color:#E1E4E8">(handler);</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">  private</span><span style="color:#B392F0"> sendToDeadLetterQueue</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">event</span><span style="color:#F97583">:</span><span style="color:#B392F0"> DomainEvent</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">error</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Error</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> void</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">    // Implementation for handling failed events</span></span>
<span class="line"><span style="color:#E1E4E8">    console.</span><span style="color:#B392F0">log</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">`Sending event ${</span><span style="color:#E1E4E8">event</span><span style="color:#9ECBFF">.</span><span style="color:#E1E4E8">eventId</span><span style="color:#9ECBFF">} to dead letter queue due to error:`</span><span style="color:#E1E4E8">, error.message);</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// Example: Order processing with event sourcing</span></span>
<span class="line"><span style="color:#F97583">class</span><span style="color:#B392F0"> OrderService</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">  constructor</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">private</span><span style="color:#FFAB70"> eventBus</span><span style="color:#F97583">:</span><span style="color:#B392F0"> EventBus</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#79B8FF">    this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">setupEventHandlers</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">  async</span><span style="color:#B392F0"> createOrder</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">customerId</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">items</span><span style="color:#F97583">:</span><span style="color:#B392F0"> CartItem</span><span style="color:#E1E4E8">[])</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Promise</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">Order</span><span style="color:#E1E4E8">> {</span></span>
<span class="line"><span style="color:#6A737D">    // Validate inventory availability</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> inventoryValidation</span><span style="color:#F97583"> =</span><span style="color:#F97583"> await</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">validateInventory</span><span style="color:#E1E4E8">(items);</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">!</span><span style="color:#E1E4E8">inventoryValidation.valid) {</span></span>
<span class="line"><span style="color:#F97583">      throw</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> Error</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">`Insufficient inventory: ${</span><span style="color:#E1E4E8">inventoryValidation</span><span style="color:#9ECBFF">.</span><span style="color:#E1E4E8">message</span><span style="color:#9ECBFF">}`</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // Create order</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> order</span><span style="color:#F97583"> =</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> Order</span><span style="color:#E1E4E8">(customerId, items);</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#6A737D">    // Publish order created event</span></span>
<span class="line"><span style="color:#79B8FF">    this</span><span style="color:#E1E4E8">.eventBus.</span><span style="color:#B392F0">publish</span><span style="color:#E1E4E8">({</span></span>
<span class="line"><span style="color:#E1E4E8">      eventId: </span><span style="color:#B392F0">generateUuid</span><span style="color:#E1E4E8">(),</span></span>
<span class="line"><span style="color:#E1E4E8">      eventType: </span><span style="color:#9ECBFF">'OrderCreated'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">      aggregateId: order.id,</span></span>
<span class="line"><span style="color:#E1E4E8">      aggregateType: </span><span style="color:#9ECBFF">'Order'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">      eventData: order.</span><span style="color:#B392F0">toJSON</span><span style="color:#E1E4E8">(),</span></span>
<span class="line"><span style="color:#E1E4E8">      timestamp: </span><span style="color:#F97583">new</span><span style="color:#B392F0"> Date</span><span style="color:#E1E4E8">(),</span></span>
<span class="line"><span style="color:#E1E4E8">      version: </span><span style="color:#79B8FF">1</span></span>
<span class="line"><span style="color:#E1E4E8">    });</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> order;</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">  private</span><span style="color:#B392F0"> setupEventHandlers</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> void</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#79B8FF">    this</span><span style="color:#E1E4E8">.eventBus.</span><span style="color:#B392F0">subscribe</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'PaymentProcessed'</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.handlePaymentProcessed.</span><span style="color:#B392F0">bind</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">));</span></span>
<span class="line"><span style="color:#79B8FF">    this</span><span style="color:#E1E4E8">.eventBus.</span><span style="color:#B392F0">subscribe</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'InventoryReserved'</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.handleInventoryReserved.</span><span style="color:#B392F0">bind</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">));</span></span>
<span class="line"><span style="color:#79B8FF">    this</span><span style="color:#E1E4E8">.eventBus.</span><span style="color:#B392F0">subscribe</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'ShippingLabelCreated'</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.handleShippingLabelCreated.</span><span style="color:#B392F0">bind</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">));</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">  private</span><span style="color:#F97583"> async</span><span style="color:#B392F0"> handlePaymentProcessed</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">event</span><span style="color:#F97583">:</span><span style="color:#B392F0"> DomainEvent</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Promise</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#79B8FF">void</span><span style="color:#E1E4E8">> {</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#E1E4E8"> { </span><span style="color:#79B8FF">orderId</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">paymentStatus</span><span style="color:#E1E4E8"> } </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> event.eventData;</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (paymentStatus </span><span style="color:#F97583">===</span><span style="color:#9ECBFF"> 'success'</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">      await</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">updateOrderStatus</span><span style="color:#E1E4E8">(orderId, </span><span style="color:#9ECBFF">'payment_confirmed'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">      </span></span>
<span class="line"><span style="color:#6A737D">      // Trigger fulfillment process</span></span>
<span class="line"><span style="color:#79B8FF">      this</span><span style="color:#E1E4E8">.eventBus.</span><span style="color:#B392F0">publish</span><span style="color:#E1E4E8">({</span></span>
<span class="line"><span style="color:#E1E4E8">        eventId: </span><span style="color:#B392F0">generateUuid</span><span style="color:#E1E4E8">(),</span></span>
<span class="line"><span style="color:#E1E4E8">        eventType: </span><span style="color:#9ECBFF">'OrderReadyForFulfillment'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">        aggregateId: orderId,</span></span>
<span class="line"><span style="color:#E1E4E8">        aggregateType: </span><span style="color:#9ECBFF">'Order'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">        eventData: { orderId },</span></span>
<span class="line"><span style="color:#E1E4E8">        timestamp: </span><span style="color:#F97583">new</span><span style="color:#B392F0"> Date</span><span style="color:#E1E4E8">(),</span></span>
<span class="line"><span style="color:#E1E4E8">        version: </span><span style="color:#79B8FF">1</span></span>
<span class="line"><span style="color:#E1E4E8">      });</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre>
<h3 id="2-product-catalog-and-search-architecture">2. Product Catalog and Search Architecture</h3>
<p>E-commerce platforms require sophisticated search and browsing capabilities.</p>
<p><strong>Elasticsearch-Based Product Search</strong></p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="typescript"><code><span class="line"><span style="color:#F97583">interface</span><span style="color:#B392F0"> ProductDocument</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#FFAB70">  id</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#FFAB70">  name</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#FFAB70">  description</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#FFAB70">  category</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#FFAB70">    id</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#FFAB70">    name</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#FFAB70">    hierarchy</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">[];</span></span>
<span class="line"><span style="color:#E1E4E8">  };</span></span>
<span class="line"><span style="color:#FFAB70">  attributes</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Record</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#79B8FF">string</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">any</span><span style="color:#E1E4E8">>;</span></span>
<span class="line"><span style="color:#FFAB70">  pricing</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#FFAB70">    basePrice</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> number</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#FFAB70">    salePrice</span><span style="color:#F97583">?:</span><span style="color:#79B8FF"> number</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#FFAB70">    currency</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">  };</span></span>
<span class="line"><span style="color:#FFAB70">  inventory</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#FFAB70">    inStock</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> boolean</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#FFAB70">    quantity</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> number</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#FFAB70">    reservedQuantity</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> number</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">  };</span></span>
<span class="line"><span style="color:#FFAB70">  images</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#FFAB70">    thumbnail</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#FFAB70">    gallery</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">[];</span></span>
<span class="line"><span style="color:#E1E4E8">  };</span></span>
<span class="line"><span style="color:#FFAB70">  seo</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#FFAB70">    slug</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#FFAB70">    metaTitle</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#FFAB70">    metaDescription</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">  };</span></span>
<span class="line"><span style="color:#FFAB70">  searchableText</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#FFAB70">  tags</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">[];</span></span>
<span class="line"><span style="color:#FFAB70">  brand</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#FFAB70">  ratings</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#FFAB70">    average</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> number</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#FFAB70">    count</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> number</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">  };</span></span>
<span class="line"><span style="color:#FFAB70">  createdAt</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Date</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#FFAB70">  updatedAt</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Date</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">class</span><span style="color:#B392F0"> ProductSearchService</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">  constructor</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">private</span><span style="color:#FFAB70"> elasticsearchClient</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> any</span><span style="color:#E1E4E8">) {}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">  async</span><span style="color:#B392F0"> searchProducts</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">query</span><span style="color:#F97583">:</span><span style="color:#B392F0"> SearchQuery</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Promise</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">SearchResults</span><span style="color:#E1E4E8">> {</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> searchBody</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">buildSearchQuery</span><span style="color:#E1E4E8">(query);</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#F97583">    try</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">      const</span><span style="color:#79B8FF"> response</span><span style="color:#F97583"> =</span><span style="color:#F97583"> await</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.elasticsearchClient.</span><span style="color:#B392F0">search</span><span style="color:#E1E4E8">({</span></span>
<span class="line"><span style="color:#E1E4E8">        index: </span><span style="color:#9ECBFF">'products'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">        body: searchBody</span></span>
<span class="line"><span style="color:#E1E4E8">      });</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">      return</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">transformSearchResults</span><span style="color:#E1E4E8">(response, query);</span></span>
<span class="line"><span style="color:#E1E4E8">    } </span><span style="color:#F97583">catch</span><span style="color:#E1E4E8"> (error) {</span></span>
<span class="line"><span style="color:#E1E4E8">      console.</span><span style="color:#B392F0">error</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'Search error:'</span><span style="color:#E1E4E8">, error);</span></span>
<span class="line"><span style="color:#F97583">      throw</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> Error</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'Search service unavailable'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">  private</span><span style="color:#B392F0"> buildSearchQuery</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">query</span><span style="color:#F97583">:</span><span style="color:#B392F0"> SearchQuery</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> any</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> searchBody</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> any</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">      query: {</span></span>
<span class="line"><span style="color:#E1E4E8">        bool: {</span></span>
<span class="line"><span style="color:#E1E4E8">          must: [],</span></span>
<span class="line"><span style="color:#E1E4E8">          should: [],</span></span>
<span class="line"><span style="color:#E1E4E8">          filter: []</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#E1E4E8">      },</span></span>
<span class="line"><span style="color:#E1E4E8">      aggs: </span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">buildAggregations</span><span style="color:#E1E4E8">(),</span></span>
<span class="line"><span style="color:#E1E4E8">      sort: </span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">buildSortCriteria</span><span style="color:#E1E4E8">(query.sort),</span></span>
<span class="line"><span style="color:#E1E4E8">      from: (query.page </span><span style="color:#F97583">-</span><span style="color:#79B8FF"> 1</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">*</span><span style="color:#E1E4E8"> query.limit,</span></span>
<span class="line"><span style="color:#E1E4E8">      size: query.limit</span></span>
<span class="line"><span style="color:#E1E4E8">    };</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // Text search</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (query.text) {</span></span>
<span class="line"><span style="color:#E1E4E8">      searchBody.query.bool.must.</span><span style="color:#B392F0">push</span><span style="color:#E1E4E8">({</span></span>
<span class="line"><span style="color:#E1E4E8">        multi_match: {</span></span>
<span class="line"><span style="color:#E1E4E8">          query: query.text,</span></span>
<span class="line"><span style="color:#E1E4E8">          fields: [</span></span>
<span class="line"><span style="color:#9ECBFF">            'name^3'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">            'description^2'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">            'searchableText'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">            'tags^2'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">            'brand^2'</span></span>
<span class="line"><span style="color:#E1E4E8">          ],</span></span>
<span class="line"><span style="color:#E1E4E8">          type: </span><span style="color:#9ECBFF">'best_fields'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">          fuzziness: </span><span style="color:#9ECBFF">'AUTO'</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#E1E4E8">      });</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // Category filter</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (query.categoryId) {</span></span>
<span class="line"><span style="color:#E1E4E8">      searchBody.query.bool.filter.</span><span style="color:#B392F0">push</span><span style="color:#E1E4E8">({</span></span>
<span class="line"><span style="color:#E1E4E8">        term: { </span><span style="color:#9ECBFF">'category.id'</span><span style="color:#E1E4E8">: query.categoryId }</span></span>
<span class="line"><span style="color:#E1E4E8">      });</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // Price range filter</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (query.priceRange) {</span></span>
<span class="line"><span style="color:#E1E4E8">      searchBody.query.bool.filter.</span><span style="color:#B392F0">push</span><span style="color:#E1E4E8">({</span></span>
<span class="line"><span style="color:#E1E4E8">        range: {</span></span>
<span class="line"><span style="color:#9ECBFF">          'pricing.basePrice'</span><span style="color:#E1E4E8">: {</span></span>
<span class="line"><span style="color:#E1E4E8">            gte: query.priceRange.min,</span></span>
<span class="line"><span style="color:#E1E4E8">            lte: query.priceRange.max</span></span>
<span class="line"><span style="color:#E1E4E8">          }</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#E1E4E8">      });</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // In stock filter</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (query.inStockOnly) {</span></span>
<span class="line"><span style="color:#E1E4E8">      searchBody.query.bool.filter.</span><span style="color:#B392F0">push</span><span style="color:#E1E4E8">({</span></span>
<span class="line"><span style="color:#E1E4E8">        term: { </span><span style="color:#9ECBFF">'inventory.inStock'</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">true</span><span style="color:#E1E4E8"> }</span></span>
<span class="line"><span style="color:#E1E4E8">      });</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // Brand filter</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (query.brands </span><span style="color:#F97583">&#x26;&#x26;</span><span style="color:#E1E4E8"> query.brands.</span><span style="color:#79B8FF">length</span><span style="color:#F97583"> ></span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">      searchBody.query.bool.filter.</span><span style="color:#B392F0">push</span><span style="color:#E1E4E8">({</span></span>
<span class="line"><span style="color:#E1E4E8">        terms: { </span><span style="color:#9ECBFF">'brand'</span><span style="color:#E1E4E8">: query.brands }</span></span>
<span class="line"><span style="color:#E1E4E8">      });</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> searchBody;</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">  private</span><span style="color:#B392F0"> buildAggregations</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> any</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">      categories: {</span></span>
<span class="line"><span style="color:#E1E4E8">        terms: {</span></span>
<span class="line"><span style="color:#E1E4E8">          field: </span><span style="color:#9ECBFF">'category.id'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">          size: </span><span style="color:#79B8FF">20</span></span>
<span class="line"><span style="color:#E1E4E8">        },</span></span>
<span class="line"><span style="color:#E1E4E8">        aggs: {</span></span>
<span class="line"><span style="color:#E1E4E8">          category_name: {</span></span>
<span class="line"><span style="color:#E1E4E8">            terms: {</span></span>
<span class="line"><span style="color:#E1E4E8">              field: </span><span style="color:#9ECBFF">'category.name'</span></span>
<span class="line"><span style="color:#E1E4E8">            }</span></span>
<span class="line"><span style="color:#E1E4E8">          }</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#E1E4E8">      },</span></span>
<span class="line"><span style="color:#E1E4E8">      brands: {</span></span>
<span class="line"><span style="color:#E1E4E8">        terms: {</span></span>
<span class="line"><span style="color:#E1E4E8">          field: </span><span style="color:#9ECBFF">'brand'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">          size: </span><span style="color:#79B8FF">20</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#E1E4E8">      },</span></span>
<span class="line"><span style="color:#E1E4E8">      price_ranges: {</span></span>
<span class="line"><span style="color:#E1E4E8">        range: {</span></span>
<span class="line"><span style="color:#E1E4E8">          field: </span><span style="color:#9ECBFF">'pricing.basePrice'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">          ranges: [</span></span>
<span class="line"><span style="color:#E1E4E8">            { key: </span><span style="color:#9ECBFF">'under_25'</span><span style="color:#E1E4E8">, to: </span><span style="color:#79B8FF">25</span><span style="color:#E1E4E8"> },</span></span>
<span class="line"><span style="color:#E1E4E8">            { key: </span><span style="color:#9ECBFF">'25_to_50'</span><span style="color:#E1E4E8">, from: </span><span style="color:#79B8FF">25</span><span style="color:#E1E4E8">, to: </span><span style="color:#79B8FF">50</span><span style="color:#E1E4E8"> },</span></span>
<span class="line"><span style="color:#E1E4E8">            { key: </span><span style="color:#9ECBFF">'50_to_100'</span><span style="color:#E1E4E8">, from: </span><span style="color:#79B8FF">50</span><span style="color:#E1E4E8">, to: </span><span style="color:#79B8FF">100</span><span style="color:#E1E4E8"> },</span></span>
<span class="line"><span style="color:#E1E4E8">            { key: </span><span style="color:#9ECBFF">'100_to_250'</span><span style="color:#E1E4E8">, from: </span><span style="color:#79B8FF">100</span><span style="color:#E1E4E8">, to: </span><span style="color:#79B8FF">250</span><span style="color:#E1E4E8"> },</span></span>
<span class="line"><span style="color:#E1E4E8">            { key: </span><span style="color:#9ECBFF">'over_250'</span><span style="color:#E1E4E8">, from: </span><span style="color:#79B8FF">250</span><span style="color:#E1E4E8"> }</span></span>
<span class="line"><span style="color:#E1E4E8">          ]</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#E1E4E8">      },</span></span>
<span class="line"><span style="color:#E1E4E8">      availability: {</span></span>
<span class="line"><span style="color:#E1E4E8">        terms: {</span></span>
<span class="line"><span style="color:#E1E4E8">          field: </span><span style="color:#9ECBFF">'inventory.inStock'</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#E1E4E8">      }</span></span>
<span class="line"><span style="color:#E1E4E8">    };</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre>
<p><strong>Product Recommendation Engine</strong></p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="typescript"><code><span class="line"><span style="color:#F97583">interface</span><span style="color:#B392F0"> RecommendationEngine</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#B392F0">  getPersonalizedRecommendations</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">userId</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">context</span><span style="color:#F97583">:</span><span style="color:#B392F0"> RecommendationContext</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Promise</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">Product</span><span style="color:#E1E4E8">[]>;</span></span>
<span class="line"><span style="color:#B392F0">  getSimilarProducts</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">productId</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">limit</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> number</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Promise</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">Product</span><span style="color:#E1E4E8">[]>;</span></span>
<span class="line"><span style="color:#B392F0">  getTrendingProducts</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">categoryId</span><span style="color:#F97583">?:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">limit</span><span style="color:#F97583">?:</span><span style="color:#79B8FF"> number</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Promise</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">Product</span><span style="color:#E1E4E8">[]>;</span></span>
<span class="line"><span style="color:#B392F0">  getFrequentlyBoughtTogether</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">productId</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Promise</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">Product</span><span style="color:#E1E4E8">[]>;</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">class</span><span style="color:#B392F0"> MLRecommendationEngine</span><span style="color:#F97583"> implements</span><span style="color:#B392F0"> RecommendationEngine</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">  constructor</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#F97583">    private</span><span style="color:#FFAB70"> userBehaviorService</span><span style="color:#F97583">:</span><span style="color:#B392F0"> UserBehaviorService</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#F97583">    private</span><span style="color:#FFAB70"> productService</span><span style="color:#F97583">:</span><span style="color:#B392F0"> ProductService</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#F97583">    private</span><span style="color:#FFAB70"> mlModel</span><span style="color:#F97583">:</span><span style="color:#B392F0"> MLModelService</span></span>
<span class="line"><span style="color:#E1E4E8">  ) {}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">  async</span><span style="color:#B392F0"> getPersonalizedRecommendations</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#FFAB70">    userId</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">, </span></span>
<span class="line"><span style="color:#FFAB70">    context</span><span style="color:#F97583">:</span><span style="color:#B392F0"> RecommendationContext</span></span>
<span class="line"><span style="color:#E1E4E8">  )</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Promise</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">Product</span><span style="color:#E1E4E8">[]> {</span></span>
<span class="line"><span style="color:#6A737D">    // Get user behavior data</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> userProfile</span><span style="color:#F97583"> =</span><span style="color:#F97583"> await</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.userBehaviorService.</span><span style="color:#B392F0">getUserProfile</span><span style="color:#E1E4E8">(userId);</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> recentInteractions</span><span style="color:#F97583"> =</span><span style="color:#F97583"> await</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.userBehaviorService.</span><span style="color:#B392F0">getRecentInteractions</span><span style="color:#E1E4E8">(userId, </span><span style="color:#79B8FF">30</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#6A737D">    // Prepare features for ML model</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> features</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">buildUserFeatures</span><span style="color:#E1E4E8">(userProfile, recentInteractions, context);</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#6A737D">    // Get recommendations from ML model</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> recommendedProductIds</span><span style="color:#F97583"> =</span><span style="color:#F97583"> await</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.mlModel.</span><span style="color:#B392F0">predict</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'product_recommendations'</span><span style="color:#E1E4E8">, features);</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#6A737D">    // Fetch product details</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> products</span><span style="color:#F97583"> =</span><span style="color:#F97583"> await</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.productService.</span><span style="color:#B392F0">getProductsByIds</span><span style="color:#E1E4E8">(recommendedProductIds);</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#6A737D">    // Apply business rules and filters</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">applyBusinessRules</span><span style="color:#E1E4E8">(products, userProfile);</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">  async</span><span style="color:#B392F0"> getSimilarProducts</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">productId</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">limit</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> number</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> 5</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Promise</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">Product</span><span style="color:#E1E4E8">[]> {</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> targetProduct</span><span style="color:#F97583"> =</span><span style="color:#F97583"> await</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.productService.</span><span style="color:#B392F0">getProduct</span><span style="color:#E1E4E8">(productId);</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#6A737D">    // Use content-based similarity (category, attributes, price range)</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> contentSimilarity</span><span style="color:#F97583"> =</span><span style="color:#F97583"> await</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">findContentSimilarProducts</span><span style="color:#E1E4E8">(targetProduct, limit </span><span style="color:#F97583">*</span><span style="color:#79B8FF"> 2</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#6A737D">    // Use collaborative filtering (users who viewed this also viewed)</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> collaborativeSimilarity</span><span style="color:#F97583"> =</span><span style="color:#F97583"> await</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">findCollaborativeSimilarProducts</span><span style="color:#E1E4E8">(productId, limit </span><span style="color:#F97583">*</span><span style="color:#79B8FF"> 2</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#6A737D">    // Combine and rank results</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> combinedResults</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">combineRecommendations</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#E1E4E8">      contentSimilarity,</span></span>
<span class="line"><span style="color:#E1E4E8">      collaborativeSimilarity,</span></span>
<span class="line"><span style="color:#79B8FF">      0.6</span><span style="color:#E1E4E8">, </span><span style="color:#6A737D">// content weight</span></span>
<span class="line"><span style="color:#79B8FF">      0.4</span><span style="color:#6A737D">  // collaborative weight</span></span>
<span class="line"><span style="color:#E1E4E8">    );</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> combinedResults.</span><span style="color:#B392F0">slice</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">, limit);</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">  private</span><span style="color:#B392F0"> buildUserFeatures</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#FFAB70">    userProfile</span><span style="color:#F97583">:</span><span style="color:#B392F0"> UserProfile</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#FFAB70">    interactions</span><span style="color:#F97583">:</span><span style="color:#B392F0"> UserInteraction</span><span style="color:#E1E4E8">[],</span></span>
<span class="line"><span style="color:#FFAB70">    context</span><span style="color:#F97583">:</span><span style="color:#B392F0"> RecommendationContext</span></span>
<span class="line"><span style="color:#E1E4E8">  )</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> any</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">      user_demographics: {</span></span>
<span class="line"><span style="color:#E1E4E8">        age_group: userProfile.ageGroup,</span></span>
<span class="line"><span style="color:#E1E4E8">        location: userProfile.location,</span></span>
<span class="line"><span style="color:#E1E4E8">        gender: userProfile.gender</span></span>
<span class="line"><span style="color:#E1E4E8">      },</span></span>
<span class="line"><span style="color:#E1E4E8">      browsing_behavior: {</span></span>
<span class="line"><span style="color:#E1E4E8">        preferred_categories: </span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">extractPreferredCategories</span><span style="color:#E1E4E8">(interactions),</span></span>
<span class="line"><span style="color:#E1E4E8">        price_sensitivity: </span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">calculatePriceSensitivity</span><span style="color:#E1E4E8">(interactions),</span></span>
<span class="line"><span style="color:#E1E4E8">        brand_preferences: </span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">extractBrandPreferences</span><span style="color:#E1E4E8">(interactions),</span></span>
<span class="line"><span style="color:#E1E4E8">        seasonal_patterns: </span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">extractSeasonalPatterns</span><span style="color:#E1E4E8">(interactions)</span></span>
<span class="line"><span style="color:#E1E4E8">      },</span></span>
<span class="line"><span style="color:#E1E4E8">      current_context: {</span></span>
<span class="line"><span style="color:#E1E4E8">        time_of_day: context.timeOfDay,</span></span>
<span class="line"><span style="color:#E1E4E8">        device_type: context.deviceType,</span></span>
<span class="line"><span style="color:#E1E4E8">        session_duration: context.sessionDuration,</span></span>
<span class="line"><span style="color:#E1E4E8">        current_cart_value: context.currentCartValue</span></span>
<span class="line"><span style="color:#E1E4E8">      },</span></span>
<span class="line"><span style="color:#E1E4E8">      purchase_history: {</span></span>
<span class="line"><span style="color:#E1E4E8">        total_orders: userProfile.totalOrders,</span></span>
<span class="line"><span style="color:#E1E4E8">        average_order_value: userProfile.averageOrderValue,</span></span>
<span class="line"><span style="color:#E1E4E8">        purchase_frequency: userProfile.purchaseFrequency,</span></span>
<span class="line"><span style="color:#E1E4E8">        last_purchase_days_ago: userProfile.daysSinceLastPurchase</span></span>
<span class="line"><span style="color:#E1E4E8">      }</span></span>
<span class="line"><span style="color:#E1E4E8">    };</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre>
<h3 id="3-shopping-cart-and-session-management">3. Shopping Cart and Session Management</h3>
<p>Cart functionality requires careful state management and persistence strategies.</p>
<p><strong>Redis-Based Cart Implementation</strong></p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="typescript"><code><span class="line"><span style="color:#F97583">interface</span><span style="color:#B392F0"> CartItem</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#FFAB70">  productId</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#FFAB70">  variantId</span><span style="color:#F97583">?:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#FFAB70">  quantity</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> number</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#FFAB70">  unitPrice</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> number</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#FFAB70">  addedAt</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Date</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#FFAB70">  customizations</span><span style="color:#F97583">?:</span><span style="color:#B392F0"> Record</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#79B8FF">string</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">any</span><span style="color:#E1E4E8">>;</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">interface</span><span style="color:#B392F0"> ShoppingCart</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#FFAB70">  cartId</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#FFAB70">  userId</span><span style="color:#F97583">?:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#FFAB70">  sessionId</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#FFAB70">  items</span><span style="color:#F97583">:</span><span style="color:#B392F0"> CartItem</span><span style="color:#E1E4E8">[];</span></span>
<span class="line"><span style="color:#FFAB70">  totals</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#FFAB70">    subtotal</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> number</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#FFAB70">    tax</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> number</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#FFAB70">    shipping</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> number</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#FFAB70">    discounts</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> number</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#FFAB70">    total</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> number</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">  };</span></span>
<span class="line"><span style="color:#FFAB70">  appliedCoupons</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">[];</span></span>
<span class="line"><span style="color:#FFAB70">  shippingAddress</span><span style="color:#F97583">?:</span><span style="color:#B392F0"> Address</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#FFAB70">  createdAt</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Date</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#FFAB70">  updatedAt</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Date</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#FFAB70">  expiresAt</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Date</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">class</span><span style="color:#B392F0"> CartService</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">  constructor</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#F97583">    private</span><span style="color:#FFAB70"> redisClient</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> any</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#F97583">    private</span><span style="color:#FFAB70"> productService</span><span style="color:#F97583">:</span><span style="color:#B392F0"> ProductService</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#F97583">    private</span><span style="color:#FFAB70"> pricingService</span><span style="color:#F97583">:</span><span style="color:#B392F0"> PricingService</span></span>
<span class="line"><span style="color:#E1E4E8">  ) {}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">  async</span><span style="color:#B392F0"> getCart</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">cartId</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Promise</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">ShoppingCart</span><span style="color:#F97583"> |</span><span style="color:#79B8FF"> null</span><span style="color:#E1E4E8">> {</span></span>
<span class="line"><span style="color:#F97583">    try</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">      const</span><span style="color:#79B8FF"> cartData</span><span style="color:#F97583"> =</span><span style="color:#F97583"> await</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.redisClient.</span><span style="color:#B392F0">get</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">`cart:${</span><span style="color:#E1E4E8">cartId</span><span style="color:#9ECBFF">}`</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">      if</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">!</span><span style="color:#E1E4E8">cartData) </span><span style="color:#F97583">return</span><span style="color:#79B8FF"> null</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">      const</span><span style="color:#79B8FF"> cart</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> JSON</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">parse</span><span style="color:#E1E4E8">(cartData);</span></span>
<span class="line"><span style="color:#E1E4E8">      </span></span>
<span class="line"><span style="color:#6A737D">      // Validate cart hasn't expired</span></span>
<span class="line"><span style="color:#F97583">      if</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">new</span><span style="color:#B392F0"> Date</span><span style="color:#E1E4E8">(cart.expiresAt) </span><span style="color:#F97583">&#x3C;</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> Date</span><span style="color:#E1E4E8">()) {</span></span>
<span class="line"><span style="color:#F97583">        await</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">deleteCart</span><span style="color:#E1E4E8">(cartId);</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#79B8FF"> null</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">      }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">      // Refresh product prices and availability</span></span>
<span class="line"><span style="color:#F97583">      return</span><span style="color:#F97583"> await</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">refreshCartData</span><span style="color:#E1E4E8">(cart);</span></span>
<span class="line"><span style="color:#E1E4E8">    } </span><span style="color:#F97583">catch</span><span style="color:#E1E4E8"> (error) {</span></span>
<span class="line"><span style="color:#E1E4E8">      console.</span><span style="color:#B392F0">error</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'Error getting cart:'</span><span style="color:#E1E4E8">, error);</span></span>
<span class="line"><span style="color:#F97583">      return</span><span style="color:#79B8FF"> null</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">  async</span><span style="color:#B392F0"> addItem</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">cartId</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">item</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Omit</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">CartItem</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'addedAt'</span><span style="color:#E1E4E8">>)</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Promise</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">ShoppingCart</span><span style="color:#E1E4E8">> {</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> cart</span><span style="color:#F97583"> =</span><span style="color:#F97583"> await</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">getCart</span><span style="color:#E1E4E8">(cartId) </span><span style="color:#F97583">||</span><span style="color:#F97583"> await</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">createCart</span><span style="color:#E1E4E8">(cartId);</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#6A737D">    // Validate product availability</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> product</span><span style="color:#F97583"> =</span><span style="color:#F97583"> await</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.productService.</span><span style="color:#B392F0">getProduct</span><span style="color:#E1E4E8">(item.productId);</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">!</span><span style="color:#E1E4E8">product </span><span style="color:#F97583">||</span><span style="color:#F97583"> !</span><span style="color:#E1E4E8">product.inventory.inStock) {</span></span>
<span class="line"><span style="color:#F97583">      throw</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> Error</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'Product is not available'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // Check if item already exists in cart</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> existingItemIndex</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> cart.items.</span><span style="color:#B392F0">findIndex</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#FFAB70">      cartItem</span><span style="color:#F97583"> =></span><span style="color:#E1E4E8"> cartItem.productId </span><span style="color:#F97583">===</span><span style="color:#E1E4E8"> item.productId </span><span style="color:#F97583">&#x26;&#x26;</span><span style="color:#E1E4E8"> cartItem.variantId </span><span style="color:#F97583">===</span><span style="color:#E1E4E8"> item.variantId</span></span>
<span class="line"><span style="color:#E1E4E8">    );</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (existingItemIndex </span><span style="color:#F97583">>=</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#6A737D">      // Update quantity</span></span>
<span class="line"><span style="color:#E1E4E8">      cart.items[existingItemIndex].quantity </span><span style="color:#F97583">+=</span><span style="color:#E1E4E8"> item.quantity;</span></span>
<span class="line"><span style="color:#E1E4E8">      cart.items[existingItemIndex].unitPrice </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> item.unitPrice; </span><span style="color:#6A737D">// Update with current price</span></span>
<span class="line"><span style="color:#E1E4E8">    } </span><span style="color:#F97583">else</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">      // Add new item</span></span>
<span class="line"><span style="color:#E1E4E8">      cart.items.</span><span style="color:#B392F0">push</span><span style="color:#E1E4E8">({</span></span>
<span class="line"><span style="color:#F97583">        ...</span><span style="color:#E1E4E8">item,</span></span>
<span class="line"><span style="color:#E1E4E8">        addedAt: </span><span style="color:#F97583">new</span><span style="color:#B392F0"> Date</span><span style="color:#E1E4E8">()</span></span>
<span class="line"><span style="color:#E1E4E8">      });</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // Recalculate totals</span></span>
<span class="line"><span style="color:#F97583">    await</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">calculateTotals</span><span style="color:#E1E4E8">(cart);</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#6A737D">    // Save cart</span></span>
<span class="line"><span style="color:#F97583">    await</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">saveCart</span><span style="color:#E1E4E8">(cart);</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> cart;</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">  async</span><span style="color:#B392F0"> removeItem</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">cartId</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">productId</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">variantId</span><span style="color:#F97583">?:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Promise</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">ShoppingCart</span><span style="color:#E1E4E8">> {</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> cart</span><span style="color:#F97583"> =</span><span style="color:#F97583"> await</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">getCart</span><span style="color:#E1E4E8">(cartId);</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">!</span><span style="color:#E1E4E8">cart) </span><span style="color:#F97583">throw</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> Error</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'Cart not found'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    cart.items </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> cart.items.</span><span style="color:#B392F0">filter</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#FFAB70">      item</span><span style="color:#F97583"> =></span><span style="color:#F97583"> !</span><span style="color:#E1E4E8">(item.productId </span><span style="color:#F97583">===</span><span style="color:#E1E4E8"> productId </span><span style="color:#F97583">&#x26;&#x26;</span><span style="color:#E1E4E8"> item.variantId </span><span style="color:#F97583">===</span><span style="color:#E1E4E8"> variantId)</span></span>
<span class="line"><span style="color:#E1E4E8">    );</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    await</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">calculateTotals</span><span style="color:#E1E4E8">(cart);</span></span>
<span class="line"><span style="color:#F97583">    await</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">saveCart</span><span style="color:#E1E4E8">(cart);</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> cart;</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">  async</span><span style="color:#B392F0"> updateQuantity</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">cartId</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">productId</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">quantity</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> number</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">variantId</span><span style="color:#F97583">?:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Promise</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">ShoppingCart</span><span style="color:#E1E4E8">> {</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> cart</span><span style="color:#F97583"> =</span><span style="color:#F97583"> await</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">getCart</span><span style="color:#E1E4E8">(cartId);</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">!</span><span style="color:#E1E4E8">cart) </span><span style="color:#F97583">throw</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> Error</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'Cart not found'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> itemIndex</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> cart.items.</span><span style="color:#B392F0">findIndex</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#FFAB70">      item</span><span style="color:#F97583"> =></span><span style="color:#E1E4E8"> item.productId </span><span style="color:#F97583">===</span><span style="color:#E1E4E8"> productId </span><span style="color:#F97583">&#x26;&#x26;</span><span style="color:#E1E4E8"> item.variantId </span><span style="color:#F97583">===</span><span style="color:#E1E4E8"> variantId</span></span>
<span class="line"><span style="color:#E1E4E8">    );</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (itemIndex </span><span style="color:#F97583">===</span><span style="color:#F97583"> -</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">throw</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> Error</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'Item not found in cart'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (quantity </span><span style="color:#F97583">&#x3C;=</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#6A737D">      // Remove item if quantity is 0 or negative</span></span>
<span class="line"><span style="color:#E1E4E8">      cart.items.</span><span style="color:#B392F0">splice</span><span style="color:#E1E4E8">(itemIndex, </span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">    } </span><span style="color:#F97583">else</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">      // Validate availability</span></span>
<span class="line"><span style="color:#F97583">      const</span><span style="color:#79B8FF"> product</span><span style="color:#F97583"> =</span><span style="color:#F97583"> await</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.productService.</span><span style="color:#B392F0">getProduct</span><span style="color:#E1E4E8">(productId);</span></span>
<span class="line"><span style="color:#F97583">      if</span><span style="color:#E1E4E8"> (quantity </span><span style="color:#F97583">></span><span style="color:#E1E4E8"> product.inventory.quantity) {</span></span>
<span class="line"><span style="color:#F97583">        throw</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> Error</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">`Only ${</span><span style="color:#E1E4E8">product</span><span style="color:#9ECBFF">.</span><span style="color:#E1E4E8">inventory</span><span style="color:#9ECBFF">.</span><span style="color:#E1E4E8">quantity</span><span style="color:#9ECBFF">} items available`</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">      }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">      cart.items[itemIndex].quantity </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> quantity;</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    await</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">calculateTotals</span><span style="color:#E1E4E8">(cart);</span></span>
<span class="line"><span style="color:#F97583">    await</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">saveCart</span><span style="color:#E1E4E8">(cart);</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> cart;</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">  private</span><span style="color:#F97583"> async</span><span style="color:#B392F0"> calculateTotals</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">cart</span><span style="color:#F97583">:</span><span style="color:#B392F0"> ShoppingCart</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Promise</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#79B8FF">void</span><span style="color:#E1E4E8">> {</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> subtotal </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // Calculate subtotal</span></span>
<span class="line"><span style="color:#F97583">    for</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">const</span><span style="color:#79B8FF"> item</span><span style="color:#F97583"> of</span><span style="color:#E1E4E8"> cart.items) {</span></span>
<span class="line"><span style="color:#E1E4E8">      subtotal </span><span style="color:#F97583">+=</span><span style="color:#E1E4E8"> item.quantity </span><span style="color:#F97583">*</span><span style="color:#E1E4E8"> item.unitPrice;</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // Apply discounts</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> discounts</span><span style="color:#F97583"> =</span><span style="color:#F97583"> await</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.pricingService.</span><span style="color:#B392F0">calculateDiscounts</span><span style="color:#E1E4E8">(cart);</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#6A737D">    // Calculate tax</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> tax</span><span style="color:#F97583"> =</span><span style="color:#F97583"> await</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.pricingService.</span><span style="color:#B392F0">calculateTax</span><span style="color:#E1E4E8">(cart, subtotal </span><span style="color:#F97583">-</span><span style="color:#E1E4E8"> discounts);</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#6A737D">    // Calculate shipping</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> shipping</span><span style="color:#F97583"> =</span><span style="color:#F97583"> await</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.pricingService.</span><span style="color:#B392F0">calculateShipping</span><span style="color:#E1E4E8">(cart);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    cart.totals </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">      subtotal,</span></span>
<span class="line"><span style="color:#E1E4E8">      tax,</span></span>
<span class="line"><span style="color:#E1E4E8">      shipping,</span></span>
<span class="line"><span style="color:#E1E4E8">      discounts,</span></span>
<span class="line"><span style="color:#E1E4E8">      total: subtotal </span><span style="color:#F97583">-</span><span style="color:#E1E4E8"> discounts </span><span style="color:#F97583">+</span><span style="color:#E1E4E8"> tax </span><span style="color:#F97583">+</span><span style="color:#E1E4E8"> shipping</span></span>
<span class="line"><span style="color:#E1E4E8">    };</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">  private</span><span style="color:#F97583"> async</span><span style="color:#B392F0"> saveCart</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">cart</span><span style="color:#F97583">:</span><span style="color:#B392F0"> ShoppingCart</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Promise</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#79B8FF">void</span><span style="color:#E1E4E8">> {</span></span>
<span class="line"><span style="color:#E1E4E8">    cart.updatedAt </span><span style="color:#F97583">=</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> Date</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#6A737D">    // Set expiration time (30 days for logged in users, 7 days for anonymous)</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> expirationDays</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> cart.userId </span><span style="color:#F97583">?</span><span style="color:#79B8FF"> 30</span><span style="color:#F97583"> :</span><span style="color:#79B8FF"> 7</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">    cart.expiresAt </span><span style="color:#F97583">=</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> Date</span><span style="color:#E1E4E8">(Date.</span><span style="color:#B392F0">now</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">+</span><span style="color:#E1E4E8"> expirationDays </span><span style="color:#F97583">*</span><span style="color:#79B8FF"> 24</span><span style="color:#F97583"> *</span><span style="color:#79B8FF"> 60</span><span style="color:#F97583"> *</span><span style="color:#79B8FF"> 60</span><span style="color:#F97583"> *</span><span style="color:#79B8FF"> 1000</span><span style="color:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    await</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.redisClient.</span><span style="color:#B392F0">setex</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#9ECBFF">      `cart:${</span><span style="color:#E1E4E8">cart</span><span style="color:#9ECBFF">.</span><span style="color:#E1E4E8">cartId</span><span style="color:#9ECBFF">}`</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">      expirationDays </span><span style="color:#F97583">*</span><span style="color:#79B8FF"> 24</span><span style="color:#F97583"> *</span><span style="color:#79B8FF"> 60</span><span style="color:#F97583"> *</span><span style="color:#79B8FF"> 60</span><span style="color:#E1E4E8">, </span><span style="color:#6A737D">// TTL in seconds</span></span>
<span class="line"><span style="color:#79B8FF">      JSON</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">stringify</span><span style="color:#E1E4E8">(cart)</span></span>
<span class="line"><span style="color:#E1E4E8">    );</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // Also maintain user cart mapping</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (cart.userId) {</span></span>
<span class="line"><span style="color:#F97583">      await</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.redisClient.</span><span style="color:#B392F0">setex</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#9ECBFF">        `user_cart:${</span><span style="color:#E1E4E8">cart</span><span style="color:#9ECBFF">.</span><span style="color:#E1E4E8">userId</span><span style="color:#9ECBFF">}`</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">        expirationDays </span><span style="color:#F97583">*</span><span style="color:#79B8FF"> 24</span><span style="color:#F97583"> *</span><span style="color:#79B8FF"> 60</span><span style="color:#F97583"> *</span><span style="color:#79B8FF"> 60</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">        cart.cartId</span></span>
<span class="line"><span style="color:#E1E4E8">      );</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">  private</span><span style="color:#F97583"> async</span><span style="color:#B392F0"> refreshCartData</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">cart</span><span style="color:#F97583">:</span><span style="color:#B392F0"> ShoppingCart</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Promise</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">ShoppingCart</span><span style="color:#E1E4E8">> {</span></span>
<span class="line"><span style="color:#6A737D">    // Update product prices and check availability</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> updatedItems</span><span style="color:#F97583">:</span><span style="color:#B392F0"> CartItem</span><span style="color:#E1E4E8">[] </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> [];</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#F97583">    for</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">const</span><span style="color:#79B8FF"> item</span><span style="color:#F97583"> of</span><span style="color:#E1E4E8"> cart.items) {</span></span>
<span class="line"><span style="color:#F97583">      const</span><span style="color:#79B8FF"> product</span><span style="color:#F97583"> =</span><span style="color:#F97583"> await</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.productService.</span><span style="color:#B392F0">getProduct</span><span style="color:#E1E4E8">(item.productId);</span></span>
<span class="line"><span style="color:#E1E4E8">      </span></span>
<span class="line"><span style="color:#F97583">      if</span><span style="color:#E1E4E8"> (product </span><span style="color:#F97583">&#x26;&#x26;</span><span style="color:#E1E4E8"> product.inventory.inStock) {</span></span>
<span class="line"><span style="color:#6A737D">        // Update price if it has changed</span></span>
<span class="line"><span style="color:#F97583">        const</span><span style="color:#79B8FF"> currentPrice</span><span style="color:#F97583"> =</span><span style="color:#F97583"> await</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.pricingService.</span><span style="color:#B392F0">getProductPrice</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#E1E4E8">          item.productId,</span></span>
<span class="line"><span style="color:#E1E4E8">          cart.userId,</span></span>
<span class="line"><span style="color:#E1E4E8">          item.variantId</span></span>
<span class="line"><span style="color:#E1E4E8">        );</span></span>
<span class="line"><span style="color:#E1E4E8">        </span></span>
<span class="line"><span style="color:#E1E4E8">        updatedItems.</span><span style="color:#B392F0">push</span><span style="color:#E1E4E8">({</span></span>
<span class="line"><span style="color:#F97583">          ...</span><span style="color:#E1E4E8">item,</span></span>
<span class="line"><span style="color:#E1E4E8">          unitPrice: currentPrice</span></span>
<span class="line"><span style="color:#E1E4E8">        });</span></span>
<span class="line"><span style="color:#E1E4E8">      }</span></span>
<span class="line"><span style="color:#6A737D">      // Skip items that are no longer available</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    cart.items </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> updatedItems;</span></span>
<span class="line"><span style="color:#F97583">    await</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">calculateTotals</span><span style="color:#E1E4E8">(cart);</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> cart;</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre>
<h3 id="4-payment-processing-architecture">4. Payment Processing Architecture</h3>
<p>Secure and reliable payment processing is critical for e-commerce success.</p>
<p><strong>Multi-Provider Payment Gateway</strong></p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="typescript"><code><span class="line"><span style="color:#F97583">interface</span><span style="color:#B392F0"> PaymentProvider</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#FFAB70">  name</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#B392F0">  processPayment</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">request</span><span style="color:#F97583">:</span><span style="color:#B392F0"> PaymentRequest</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Promise</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">PaymentResult</span><span style="color:#E1E4E8">>;</span></span>
<span class="line"><span style="color:#B392F0">  capturePayment</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">transactionId</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">amount</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> number</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Promise</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">PaymentResult</span><span style="color:#E1E4E8">>;</span></span>
<span class="line"><span style="color:#B392F0">  refundPayment</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">transactionId</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">amount</span><span style="color:#F97583">?:</span><span style="color:#79B8FF"> number</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Promise</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">PaymentResult</span><span style="color:#E1E4E8">>;</span></span>
<span class="line"><span style="color:#B392F0">  validateWebhook</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">payload</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> any</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">signature</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> boolean</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">interface</span><span style="color:#B392F0"> PaymentRequest</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#FFAB70">  amount</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> number</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#FFAB70">  currency</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#FFAB70">  paymentMethod</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#FFAB70">    type</span><span style="color:#F97583">:</span><span style="color:#9ECBFF"> 'card'</span><span style="color:#F97583"> |</span><span style="color:#9ECBFF"> 'digital_wallet'</span><span style="color:#F97583"> |</span><span style="color:#9ECBFF"> 'bank_transfer'</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#FFAB70">    token</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#FFAB70">    billingAddress</span><span style="color:#F97583">?:</span><span style="color:#B392F0"> Address</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">  };</span></span>
<span class="line"><span style="color:#FFAB70">  customer</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#FFAB70">    id</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#FFAB70">    email</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#FFAB70">    name</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">  };</span></span>
<span class="line"><span style="color:#FFAB70">  order</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#FFAB70">    id</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#FFAB70">    description</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#FFAB70">    items</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Array</span><span style="color:#E1E4E8">&#x3C;{ </span><span style="color:#FFAB70">name</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">; </span><span style="color:#FFAB70">quantity</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> number</span><span style="color:#E1E4E8">; </span><span style="color:#FFAB70">amount</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> number</span><span style="color:#E1E4E8"> }>;</span></span>
<span class="line"><span style="color:#E1E4E8">  };</span></span>
<span class="line"><span style="color:#FFAB70">  metadata</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Record</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#79B8FF">string</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">any</span><span style="color:#E1E4E8">>;</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">interface</span><span style="color:#B392F0"> PaymentResult</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#FFAB70">  success</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> boolean</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#FFAB70">  transactionId</span><span style="color:#F97583">?:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#FFAB70">  status</span><span style="color:#F97583">:</span><span style="color:#9ECBFF"> 'pending'</span><span style="color:#F97583"> |</span><span style="color:#9ECBFF"> 'processing'</span><span style="color:#F97583"> |</span><span style="color:#9ECBFF"> 'succeeded'</span><span style="color:#F97583"> |</span><span style="color:#9ECBFF"> 'failed'</span><span style="color:#F97583"> |</span><span style="color:#9ECBFF"> 'cancelled'</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#FFAB70">  amount</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> number</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#FFAB70">  fees</span><span style="color:#F97583">?:</span><span style="color:#79B8FF"> number</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#FFAB70">  errorCode</span><span style="color:#F97583">?:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#FFAB70">  errorMessage</span><span style="color:#F97583">?:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#FFAB70">  providerResponse</span><span style="color:#F97583">?:</span><span style="color:#79B8FF"> any</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">class</span><span style="color:#B392F0"> StripePaymentProvider</span><span style="color:#F97583"> implements</span><span style="color:#B392F0"> PaymentProvider</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#FFAB70">  name</span><span style="color:#F97583"> =</span><span style="color:#9ECBFF"> 'stripe'</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">  </span></span>
<span class="line"><span style="color:#F97583">  constructor</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">private</span><span style="color:#FFAB70"> stripeClient</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> any</span><span style="color:#E1E4E8">) {}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">  async</span><span style="color:#B392F0"> processPayment</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">request</span><span style="color:#F97583">:</span><span style="color:#B392F0"> PaymentRequest</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Promise</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">PaymentResult</span><span style="color:#E1E4E8">> {</span></span>
<span class="line"><span style="color:#F97583">    try</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">      const</span><span style="color:#79B8FF"> paymentIntent</span><span style="color:#F97583"> =</span><span style="color:#F97583"> await</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.stripeClient.paymentIntents.</span><span style="color:#B392F0">create</span><span style="color:#E1E4E8">({</span></span>
<span class="line"><span style="color:#E1E4E8">        amount: Math.</span><span style="color:#B392F0">round</span><span style="color:#E1E4E8">(request.amount </span><span style="color:#F97583">*</span><span style="color:#79B8FF"> 100</span><span style="color:#E1E4E8">), </span><span style="color:#6A737D">// Convert to cents</span></span>
<span class="line"><span style="color:#E1E4E8">        currency: request.currency.</span><span style="color:#B392F0">toLowerCase</span><span style="color:#E1E4E8">(),</span></span>
<span class="line"><span style="color:#E1E4E8">        payment_method: request.paymentMethod.token,</span></span>
<span class="line"><span style="color:#E1E4E8">        customer: request.customer.id,</span></span>
<span class="line"><span style="color:#E1E4E8">        description: request.order.description,</span></span>
<span class="line"><span style="color:#E1E4E8">        metadata: {</span></span>
<span class="line"><span style="color:#E1E4E8">          orderId: request.order.id,</span></span>
<span class="line"><span style="color:#F97583">          ...</span><span style="color:#E1E4E8">request.metadata</span></span>
<span class="line"><span style="color:#E1E4E8">        },</span></span>
<span class="line"><span style="color:#E1E4E8">        confirm: </span><span style="color:#79B8FF">true</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">        return_url: process.env.</span><span style="color:#79B8FF">PAYMENT_RETURN_URL</span></span>
<span class="line"><span style="color:#E1E4E8">      });</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">      return</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">        success: paymentIntent.status </span><span style="color:#F97583">===</span><span style="color:#9ECBFF"> 'succeeded'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">        transactionId: paymentIntent.id,</span></span>
<span class="line"><span style="color:#E1E4E8">        status: </span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">mapStripeStatus</span><span style="color:#E1E4E8">(paymentIntent.status),</span></span>
<span class="line"><span style="color:#E1E4E8">        amount: paymentIntent.amount </span><span style="color:#F97583">/</span><span style="color:#79B8FF"> 100</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">        fees: paymentIntent.application_fee_amount </span><span style="color:#F97583">?</span><span style="color:#E1E4E8"> paymentIntent.application_fee_amount </span><span style="color:#F97583">/</span><span style="color:#79B8FF"> 100</span><span style="color:#F97583"> :</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">        providerResponse: paymentIntent</span></span>
<span class="line"><span style="color:#E1E4E8">      };</span></span>
<span class="line"><span style="color:#E1E4E8">    } </span><span style="color:#F97583">catch</span><span style="color:#E1E4E8"> (</span><span style="color:#FFAB70">error</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> any</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">      return</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">        success: </span><span style="color:#79B8FF">false</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">        status: </span><span style="color:#9ECBFF">'failed'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">        amount: request.amount,</span></span>
<span class="line"><span style="color:#E1E4E8">        errorCode: error.code,</span></span>
<span class="line"><span style="color:#E1E4E8">        errorMessage: error.message</span></span>
<span class="line"><span style="color:#E1E4E8">      };</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">  async</span><span style="color:#B392F0"> capturePayment</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">transactionId</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">amount</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> number</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Promise</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">PaymentResult</span><span style="color:#E1E4E8">> {</span></span>
<span class="line"><span style="color:#F97583">    try</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">      const</span><span style="color:#79B8FF"> paymentIntent</span><span style="color:#F97583"> =</span><span style="color:#F97583"> await</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.stripeClient.paymentIntents.</span><span style="color:#B392F0">capture</span><span style="color:#E1E4E8">(transactionId, {</span></span>
<span class="line"><span style="color:#E1E4E8">        amount_to_capture: Math.</span><span style="color:#B392F0">round</span><span style="color:#E1E4E8">(amount </span><span style="color:#F97583">*</span><span style="color:#79B8FF"> 100</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">      });</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">      return</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">        success: </span><span style="color:#79B8FF">true</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">        transactionId: paymentIntent.id,</span></span>
<span class="line"><span style="color:#E1E4E8">        status: </span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">mapStripeStatus</span><span style="color:#E1E4E8">(paymentIntent.status),</span></span>
<span class="line"><span style="color:#E1E4E8">        amount: paymentIntent.amount_received </span><span style="color:#F97583">/</span><span style="color:#79B8FF"> 100</span></span>
<span class="line"><span style="color:#E1E4E8">      };</span></span>
<span class="line"><span style="color:#E1E4E8">    } </span><span style="color:#F97583">catch</span><span style="color:#E1E4E8"> (</span><span style="color:#FFAB70">error</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> any</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">      return</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">        success: </span><span style="color:#79B8FF">false</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">        status: </span><span style="color:#9ECBFF">'failed'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">        amount,</span></span>
<span class="line"><span style="color:#E1E4E8">        errorCode: error.code,</span></span>
<span class="line"><span style="color:#E1E4E8">        errorMessage: error.message</span></span>
<span class="line"><span style="color:#E1E4E8">      };</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">  validateWebhook</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">payload</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> any</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">signature</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> boolean</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">    try</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#79B8FF">      this</span><span style="color:#E1E4E8">.stripeClient.webhooks.</span><span style="color:#B392F0">constructEvent</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#E1E4E8">        payload,</span></span>
<span class="line"><span style="color:#E1E4E8">        signature,</span></span>
<span class="line"><span style="color:#E1E4E8">        process.env.</span><span style="color:#79B8FF">STRIPE_WEBHOOK_SECRET</span></span>
<span class="line"><span style="color:#E1E4E8">      );</span></span>
<span class="line"><span style="color:#F97583">      return</span><span style="color:#79B8FF"> true</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">    } </span><span style="color:#F97583">catch</span><span style="color:#E1E4E8"> (error) {</span></span>
<span class="line"><span style="color:#F97583">      return</span><span style="color:#79B8FF"> false</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">  private</span><span style="color:#B392F0"> mapStripeStatus</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">stripeStatus</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">:</span><span style="color:#B392F0"> PaymentResult</span><span style="color:#E1E4E8">[</span><span style="color:#9ECBFF">'status'</span><span style="color:#E1E4E8">] {</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> statusMap</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Record</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#79B8FF">string</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">PaymentResult</span><span style="color:#E1E4E8">[</span><span style="color:#9ECBFF">'status'</span><span style="color:#E1E4E8">]> </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#9ECBFF">      'requires_payment_method'</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">'pending'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">      'requires_confirmation'</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">'pending'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">      'requires_action'</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">'pending'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">      'processing'</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">'processing'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">      'succeeded'</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">'succeeded'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">      'canceled'</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">'cancelled'</span></span>
<span class="line"><span style="color:#E1E4E8">    };</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> statusMap[stripeStatus] </span><span style="color:#F97583">||</span><span style="color:#9ECBFF"> 'failed'</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">class</span><span style="color:#B392F0"> PaymentOrchestrator</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">  private</span><span style="color:#FFAB70"> providers</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Map</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#79B8FF">string</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">PaymentProvider</span><span style="color:#E1E4E8">> </span><span style="color:#F97583">=</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> Map</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">  private</span><span style="color:#FFAB70"> routingRules</span><span style="color:#F97583">:</span><span style="color:#B392F0"> PaymentRoutingRule</span><span style="color:#E1E4E8">[] </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> [];</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">  constructor</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#79B8FF">    this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">initializeProviders</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#79B8FF">    this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">loadRoutingRules</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">  async</span><span style="color:#B392F0"> processPayment</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">request</span><span style="color:#F97583">:</span><span style="color:#B392F0"> PaymentRequest</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Promise</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">PaymentResult</span><span style="color:#E1E4E8">> {</span></span>
<span class="line"><span style="color:#6A737D">    // Select payment provider based on routing rules</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> provider</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">selectProvider</span><span style="color:#E1E4E8">(request);</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#6A737D">    // Add fraud detection</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> fraudScore</span><span style="color:#F97583"> =</span><span style="color:#F97583"> await</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">checkFraud</span><span style="color:#E1E4E8">(request);</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (fraudScore </span><span style="color:#F97583">></span><span style="color:#79B8FF"> 0.8</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">      return</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">        success: </span><span style="color:#79B8FF">false</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">        status: </span><span style="color:#9ECBFF">'failed'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">        amount: request.amount,</span></span>
<span class="line"><span style="color:#E1E4E8">        errorCode: </span><span style="color:#9ECBFF">'FRAUD_DETECTED'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">        errorMessage: </span><span style="color:#9ECBFF">'Transaction flagged for potential fraud'</span></span>
<span class="line"><span style="color:#E1E4E8">      };</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // Process payment with selected provider</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> result</span><span style="color:#F97583"> =</span><span style="color:#F97583"> await</span><span style="color:#E1E4E8"> provider.</span><span style="color:#B392F0">processPayment</span><span style="color:#E1E4E8">(request);</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#6A737D">    // Log transaction</span></span>
<span class="line"><span style="color:#F97583">    await</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">logPaymentTransaction</span><span style="color:#E1E4E8">(request, result, provider.name);</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#6A737D">    // Send analytics event</span></span>
<span class="line"><span style="color:#F97583">    await</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">trackPaymentEvent</span><span style="color:#E1E4E8">(request, result);</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> result;</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">  private</span><span style="color:#B392F0"> selectProvider</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">request</span><span style="color:#F97583">:</span><span style="color:#B392F0"> PaymentRequest</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">:</span><span style="color:#B392F0"> PaymentProvider</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">    // Apply routing rules to select best provider</span></span>
<span class="line"><span style="color:#F97583">    for</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">const</span><span style="color:#79B8FF"> rule</span><span style="color:#F97583"> of</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.routingRules) {</span></span>
<span class="line"><span style="color:#F97583">      if</span><span style="color:#E1E4E8"> (</span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">matchesRule</span><span style="color:#E1E4E8">(request, rule)) {</span></span>
<span class="line"><span style="color:#F97583">        const</span><span style="color:#79B8FF"> provider</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.providers.</span><span style="color:#B392F0">get</span><span style="color:#E1E4E8">(rule.providerId);</span></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#E1E4E8"> (provider) </span><span style="color:#F97583">return</span><span style="color:#E1E4E8"> provider;</span></span>
<span class="line"><span style="color:#E1E4E8">      }</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#6A737D">    // Default to primary provider</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.providers.</span><span style="color:#B392F0">get</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'stripe'</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">!</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">  private</span><span style="color:#F97583"> async</span><span style="color:#B392F0"> checkFraud</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">request</span><span style="color:#F97583">:</span><span style="color:#B392F0"> PaymentRequest</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Promise</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#79B8FF">number</span><span style="color:#E1E4E8">> {</span></span>
<span class="line"><span style="color:#6A737D">    // Implement fraud detection logic</span></span>
<span class="line"><span style="color:#6A737D">    // Check against known fraud patterns, velocity rules, etc.</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> riskScore </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // Example fraud checks</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (request.amount </span><span style="color:#F97583">></span><span style="color:#79B8FF"> 1000</span><span style="color:#E1E4E8">) riskScore </span><span style="color:#F97583">+=</span><span style="color:#79B8FF"> 0.1</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (request.customer.email.</span><span style="color:#B392F0">includes</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'test'</span><span style="color:#E1E4E8">)) riskScore </span><span style="color:#F97583">+=</span><span style="color:#79B8FF"> 0.2</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#6A737D">    // Check velocity (number of transactions from same customer/IP)</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> recentTransactions</span><span style="color:#F97583"> =</span><span style="color:#F97583"> await</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">getRecentTransactions</span><span style="color:#E1E4E8">(request.customer.id, </span><span style="color:#79B8FF">24</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (recentTransactions </span><span style="color:#F97583">></span><span style="color:#79B8FF"> 5</span><span style="color:#E1E4E8">) riskScore </span><span style="color:#F97583">+=</span><span style="color:#79B8FF"> 0.3</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> Math.</span><span style="color:#B392F0">min</span><span style="color:#E1E4E8">(riskScore, </span><span style="color:#79B8FF">1.0</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre>
<h3 id="5-order-management-and-fulfillment">5. Order Management and Fulfillment</h3>
<p>Efficient order processing workflows are essential for customer satisfaction.</p>
<p><strong>Order State Machine</strong></p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="typescript"><code><span class="line"><span style="color:#F97583">type</span><span style="color:#B392F0"> OrderStatus</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> </span></span>
<span class="line"><span style="color:#F97583">  |</span><span style="color:#9ECBFF"> 'pending'</span></span>
<span class="line"><span style="color:#F97583">  |</span><span style="color:#9ECBFF"> 'payment_pending'</span></span>
<span class="line"><span style="color:#F97583">  |</span><span style="color:#9ECBFF"> 'payment_confirmed'</span></span>
<span class="line"><span style="color:#F97583">  |</span><span style="color:#9ECBFF"> 'processing'</span></span>
<span class="line"><span style="color:#F97583">  |</span><span style="color:#9ECBFF"> 'ready_to_ship'</span></span>
<span class="line"><span style="color:#F97583">  |</span><span style="color:#9ECBFF"> 'shipped'</span></span>
<span class="line"><span style="color:#F97583">  |</span><span style="color:#9ECBFF"> 'delivered'</span></span>
<span class="line"><span style="color:#F97583">  |</span><span style="color:#9ECBFF"> 'cancelled'</span></span>
<span class="line"><span style="color:#F97583">  |</span><span style="color:#9ECBFF"> 'refunded'</span></span>
<span class="line"><span style="color:#F97583">  |</span><span style="color:#9ECBFF"> 'returned'</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">interface</span><span style="color:#B392F0"> OrderTransition</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#FFAB70">  from</span><span style="color:#F97583">:</span><span style="color:#B392F0"> OrderStatus</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#FFAB70">  to</span><span style="color:#F97583">:</span><span style="color:#B392F0"> OrderStatus</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#FFAB70">  trigger</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#FFAB70">  conditions</span><span style="color:#F97583">?:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">[];</span></span>
<span class="line"><span style="color:#FFAB70">  actions</span><span style="color:#F97583">?:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">[];</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">class</span><span style="color:#B392F0"> OrderStateMachine</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">  private</span><span style="color:#FFAB70"> transitions</span><span style="color:#F97583">:</span><span style="color:#B392F0"> OrderTransition</span><span style="color:#E1E4E8">[] </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> [</span></span>
<span class="line"><span style="color:#E1E4E8">    {</span></span>
<span class="line"><span style="color:#E1E4E8">      from: </span><span style="color:#9ECBFF">'pending'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">      to: </span><span style="color:#9ECBFF">'payment_pending'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">      trigger: </span><span style="color:#9ECBFF">'initiate_payment'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">      actions: [</span><span style="color:#9ECBFF">'reserve_inventory'</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'create_payment_intent'</span><span style="color:#E1E4E8">]</span></span>
<span class="line"><span style="color:#E1E4E8">    },</span></span>
<span class="line"><span style="color:#E1E4E8">    {</span></span>
<span class="line"><span style="color:#E1E4E8">      from: </span><span style="color:#9ECBFF">'payment_pending'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">      to: </span><span style="color:#9ECBFF">'payment_confirmed'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">      trigger: </span><span style="color:#9ECBFF">'payment_success'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">      actions: [</span><span style="color:#9ECBFF">'confirm_inventory_reservation'</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'send_confirmation_email'</span><span style="color:#E1E4E8">]</span></span>
<span class="line"><span style="color:#E1E4E8">    },</span></span>
<span class="line"><span style="color:#E1E4E8">    {</span></span>
<span class="line"><span style="color:#E1E4E8">      from: </span><span style="color:#9ECBFF">'payment_confirmed'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">      to: </span><span style="color:#9ECBFF">'processing'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">      trigger: </span><span style="color:#9ECBFF">'start_fulfillment'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">      actions: [</span><span style="color:#9ECBFF">'allocate_inventory'</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'notify_warehouse'</span><span style="color:#E1E4E8">]</span></span>
<span class="line"><span style="color:#E1E4E8">    },</span></span>
<span class="line"><span style="color:#E1E4E8">    {</span></span>
<span class="line"><span style="color:#E1E4E8">      from: </span><span style="color:#9ECBFF">'processing'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">      to: </span><span style="color:#9ECBFF">'ready_to_ship'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">      trigger: </span><span style="color:#9ECBFF">'items_picked'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">      conditions: [</span><span style="color:#9ECBFF">'all_items_available'</span><span style="color:#E1E4E8">],</span></span>
<span class="line"><span style="color:#E1E4E8">      actions: [</span><span style="color:#9ECBFF">'create_shipping_label'</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'generate_packing_list'</span><span style="color:#E1E4E8">]</span></span>
<span class="line"><span style="color:#E1E4E8">    },</span></span>
<span class="line"><span style="color:#E1E4E8">    {</span></span>
<span class="line"><span style="color:#E1E4E8">      from: </span><span style="color:#9ECBFF">'ready_to_ship'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">      to: </span><span style="color:#9ECBFF">'shipped'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">      trigger: </span><span style="color:#9ECBFF">'package_dispatched'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">      actions: [</span><span style="color:#9ECBFF">'update_tracking_info'</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'send_shipping_notification'</span><span style="color:#E1E4E8">]</span></span>
<span class="line"><span style="color:#E1E4E8">    },</span></span>
<span class="line"><span style="color:#E1E4E8">    {</span></span>
<span class="line"><span style="color:#E1E4E8">      from: </span><span style="color:#9ECBFF">'shipped'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">      to: </span><span style="color:#9ECBFF">'delivered'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">      trigger: </span><span style="color:#9ECBFF">'delivery_confirmed'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">      actions: [</span><span style="color:#9ECBFF">'update_delivery_date'</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'send_delivery_notification'</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'request_feedback'</span><span style="color:#E1E4E8">]</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">  ];</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">  canTransition</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">currentStatus</span><span style="color:#F97583">:</span><span style="color:#B392F0"> OrderStatus</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">trigger</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> boolean</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.transitions.</span><span style="color:#B392F0">some</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#FFAB70">      transition</span><span style="color:#F97583"> =></span><span style="color:#E1E4E8"> transition.from </span><span style="color:#F97583">===</span><span style="color:#E1E4E8"> currentStatus </span><span style="color:#F97583">&#x26;&#x26;</span><span style="color:#E1E4E8"> transition.trigger </span><span style="color:#F97583">===</span><span style="color:#E1E4E8"> trigger</span></span>
<span class="line"><span style="color:#E1E4E8">    );</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">  async</span><span style="color:#B392F0"> executeTransition</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">order</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Order</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">trigger</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Promise</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">Order</span><span style="color:#E1E4E8">> {</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> transition</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.transitions.</span><span style="color:#B392F0">find</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#FFAB70">      t</span><span style="color:#F97583"> =></span><span style="color:#E1E4E8"> t.from </span><span style="color:#F97583">===</span><span style="color:#E1E4E8"> order.status </span><span style="color:#F97583">&#x26;&#x26;</span><span style="color:#E1E4E8"> t.trigger </span><span style="color:#F97583">===</span><span style="color:#E1E4E8"> trigger</span></span>
<span class="line"><span style="color:#E1E4E8">    );</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">!</span><span style="color:#E1E4E8">transition) {</span></span>
<span class="line"><span style="color:#F97583">      throw</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> Error</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">`Invalid transition: ${</span><span style="color:#E1E4E8">order</span><span style="color:#9ECBFF">.</span><span style="color:#E1E4E8">status</span><span style="color:#9ECBFF">} -> ${</span><span style="color:#E1E4E8">trigger</span><span style="color:#9ECBFF">}`</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // Check conditions</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (transition.conditions) {</span></span>
<span class="line"><span style="color:#F97583">      for</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">const</span><span style="color:#79B8FF"> condition</span><span style="color:#F97583"> of</span><span style="color:#E1E4E8"> transition.conditions) {</span></span>
<span class="line"><span style="color:#F97583">        const</span><span style="color:#79B8FF"> conditionMet</span><span style="color:#F97583"> =</span><span style="color:#F97583"> await</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">checkCondition</span><span style="color:#E1E4E8">(order, condition);</span></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">!</span><span style="color:#E1E4E8">conditionMet) {</span></span>
<span class="line"><span style="color:#F97583">          throw</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> Error</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">`Condition not met: ${</span><span style="color:#E1E4E8">condition</span><span style="color:#9ECBFF">}`</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#E1E4E8">      }</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // Execute actions</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (transition.actions) {</span></span>
<span class="line"><span style="color:#F97583">      for</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">const</span><span style="color:#79B8FF"> action</span><span style="color:#F97583"> of</span><span style="color:#E1E4E8"> transition.actions) {</span></span>
<span class="line"><span style="color:#F97583">        await</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">executeAction</span><span style="color:#E1E4E8">(order, action);</span></span>
<span class="line"><span style="color:#E1E4E8">      }</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // Update order status</span></span>
<span class="line"><span style="color:#E1E4E8">    order.status </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> transition.to;</span></span>
<span class="line"><span style="color:#E1E4E8">    order.statusHistory.</span><span style="color:#B392F0">push</span><span style="color:#E1E4E8">({</span></span>
<span class="line"><span style="color:#E1E4E8">      status: transition.to,</span></span>
<span class="line"><span style="color:#E1E4E8">      timestamp: </span><span style="color:#F97583">new</span><span style="color:#B392F0"> Date</span><span style="color:#E1E4E8">(),</span></span>
<span class="line"><span style="color:#E1E4E8">      trigger,</span></span>
<span class="line"><span style="color:#E1E4E8">      notes: </span><span style="color:#9ECBFF">`Transitioned from ${</span><span style="color:#E1E4E8">transition</span><span style="color:#9ECBFF">.</span><span style="color:#E1E4E8">from</span><span style="color:#9ECBFF">} to ${</span><span style="color:#E1E4E8">transition</span><span style="color:#9ECBFF">.</span><span style="color:#E1E4E8">to</span><span style="color:#9ECBFF">}`</span></span>
<span class="line"><span style="color:#E1E4E8">    });</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> order;</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">  private</span><span style="color:#F97583"> async</span><span style="color:#B392F0"> checkCondition</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">order</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Order</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">condition</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Promise</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#79B8FF">boolean</span><span style="color:#E1E4E8">> {</span></span>
<span class="line"><span style="color:#F97583">    switch</span><span style="color:#E1E4E8"> (condition) {</span></span>
<span class="line"><span style="color:#F97583">      case</span><span style="color:#9ECBFF"> 'all_items_available'</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#F97583"> await</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">verifyInventoryAvailability</span><span style="color:#E1E4E8">(order);</span></span>
<span class="line"><span style="color:#F97583">      case</span><span style="color:#9ECBFF"> 'payment_confirmed'</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#E1E4E8"> order.payment?.status </span><span style="color:#F97583">===</span><span style="color:#9ECBFF"> 'succeeded'</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">      default</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#79B8FF"> true</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">  private</span><span style="color:#F97583"> async</span><span style="color:#B392F0"> executeAction</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">order</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Order</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">action</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Promise</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#79B8FF">void</span><span style="color:#E1E4E8">> {</span></span>
<span class="line"><span style="color:#F97583">    switch</span><span style="color:#E1E4E8"> (action) {</span></span>
<span class="line"><span style="color:#F97583">      case</span><span style="color:#9ECBFF"> 'reserve_inventory'</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#F97583">        await</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">reserveInventory</span><span style="color:#E1E4E8">(order);</span></span>
<span class="line"><span style="color:#F97583">        break</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">      case</span><span style="color:#9ECBFF"> 'send_confirmation_email'</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#F97583">        await</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">sendOrderConfirmationEmail</span><span style="color:#E1E4E8">(order);</span></span>
<span class="line"><span style="color:#F97583">        break</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">      case</span><span style="color:#9ECBFF"> 'notify_warehouse'</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#F97583">        await</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">notifyWarehouse</span><span style="color:#E1E4E8">(order);</span></span>
<span class="line"><span style="color:#F97583">        break</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">      case</span><span style="color:#9ECBFF"> 'create_shipping_label'</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#F97583">        await</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">createShippingLabel</span><span style="color:#E1E4E8">(order);</span></span>
<span class="line"><span style="color:#F97583">        break</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">      case</span><span style="color:#9ECBFF"> 'send_shipping_notification'</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#F97583">        await</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">sendShippingNotification</span><span style="color:#E1E4E8">(order);</span></span>
<span class="line"><span style="color:#F97583">        break</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#6A737D">      // Add more actions as needed</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre>
<h2 id="performance-optimization-strategies">Performance Optimization Strategies</h2>
<h3 id="1-caching-architecture">1. Caching Architecture</h3>
<p>Multi-layered caching improves response times and reduces database load.</p>
<p><strong>Comprehensive Caching Strategy</strong></p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="typescript"><code><span class="line"><span style="color:#F97583">interface</span><span style="color:#B392F0"> CacheLayer</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#FFAB70">  name</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#FFAB70">  ttl</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> number</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#FFAB70">  storage</span><span style="color:#F97583">:</span><span style="color:#9ECBFF"> 'memory'</span><span style="color:#F97583"> |</span><span style="color:#9ECBFF"> 'redis'</span><span style="color:#F97583"> |</span><span style="color:#9ECBFF"> 'cdn'</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#FFAB70">  keyPattern</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">class</span><span style="color:#B392F0"> EcommerceCacheManager</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">  private</span><span style="color:#FFAB70"> cacheConfig</span><span style="color:#F97583">:</span><span style="color:#B392F0"> CacheLayer</span><span style="color:#E1E4E8">[] </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> [</span></span>
<span class="line"><span style="color:#E1E4E8">    {</span></span>
<span class="line"><span style="color:#E1E4E8">      name: </span><span style="color:#9ECBFF">'product_details'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">      ttl: </span><span style="color:#79B8FF">3600</span><span style="color:#E1E4E8">, </span><span style="color:#6A737D">// 1 hour</span></span>
<span class="line"><span style="color:#E1E4E8">      storage: </span><span style="color:#9ECBFF">'redis'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">      keyPattern: </span><span style="color:#9ECBFF">'product:{productId}'</span></span>
<span class="line"><span style="color:#E1E4E8">    },</span></span>
<span class="line"><span style="color:#E1E4E8">    {</span></span>
<span class="line"><span style="color:#E1E4E8">      name: </span><span style="color:#9ECBFF">'category_tree'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">      ttl: </span><span style="color:#79B8FF">7200</span><span style="color:#E1E4E8">, </span><span style="color:#6A737D">// 2 hours</span></span>
<span class="line"><span style="color:#E1E4E8">      storage: </span><span style="color:#9ECBFF">'redis'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">      keyPattern: </span><span style="color:#9ECBFF">'categories:tree'</span></span>
<span class="line"><span style="color:#E1E4E8">    },</span></span>
<span class="line"><span style="color:#E1E4E8">    {</span></span>
<span class="line"><span style="color:#E1E4E8">      name: </span><span style="color:#9ECBFF">'search_results'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">      ttl: </span><span style="color:#79B8FF">900</span><span style="color:#E1E4E8">, </span><span style="color:#6A737D">// 15 minutes</span></span>
<span class="line"><span style="color:#E1E4E8">      storage: </span><span style="color:#9ECBFF">'redis'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">      keyPattern: </span><span style="color:#9ECBFF">'search:{hash}'</span></span>
<span class="line"><span style="color:#E1E4E8">    },</span></span>
<span class="line"><span style="color:#E1E4E8">    {</span></span>
<span class="line"><span style="color:#E1E4E8">      name: </span><span style="color:#9ECBFF">'user_session'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">      ttl: </span><span style="color:#79B8FF">1800</span><span style="color:#E1E4E8">, </span><span style="color:#6A737D">// 30 minutes</span></span>
<span class="line"><span style="color:#E1E4E8">      storage: </span><span style="color:#9ECBFF">'redis'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">      keyPattern: </span><span style="color:#9ECBFF">'session:{sessionId}'</span></span>
<span class="line"><span style="color:#E1E4E8">    },</span></span>
<span class="line"><span style="color:#E1E4E8">    {</span></span>
<span class="line"><span style="color:#E1E4E8">      name: </span><span style="color:#9ECBFF">'static_content'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">      ttl: </span><span style="color:#79B8FF">86400</span><span style="color:#E1E4E8">, </span><span style="color:#6A737D">// 24 hours</span></span>
<span class="line"><span style="color:#E1E4E8">      storage: </span><span style="color:#9ECBFF">'cdn'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">      keyPattern: </span><span style="color:#9ECBFF">'static:{path}'</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">  ];</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">  async</span><span style="color:#B392F0"> getProduct</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">productId</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Promise</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">Product</span><span style="color:#F97583"> |</span><span style="color:#79B8FF"> null</span><span style="color:#E1E4E8">> {</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> cacheKey</span><span style="color:#F97583"> =</span><span style="color:#9ECBFF"> `product:${</span><span style="color:#E1E4E8">productId</span><span style="color:#9ECBFF">}`</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#6A737D">    // Try cache first</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> product </span><span style="color:#F97583">=</span><span style="color:#F97583"> await</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">getFromCache</span><span style="color:#E1E4E8">(cacheKey);</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (product) {</span></span>
<span class="line"><span style="color:#F97583">      return</span><span style="color:#E1E4E8"> product;</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // Fetch from database</span></span>
<span class="line"><span style="color:#E1E4E8">    product </span><span style="color:#F97583">=</span><span style="color:#F97583"> await</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.productRepository.</span><span style="color:#B392F0">findById</span><span style="color:#E1E4E8">(productId);</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (product) {</span></span>
<span class="line"><span style="color:#6A737D">      // Cache for future requests</span></span>
<span class="line"><span style="color:#F97583">      await</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">setCache</span><span style="color:#E1E4E8">(cacheKey, product, </span><span style="color:#79B8FF">3600</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> product;</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">  async</span><span style="color:#B392F0"> invalidateProductCache</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">productId</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Promise</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#79B8FF">void</span><span style="color:#E1E4E8">> {</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> keys</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> [</span></span>
<span class="line"><span style="color:#9ECBFF">      `product:${</span><span style="color:#E1E4E8">productId</span><span style="color:#9ECBFF">}`</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">      `product:${</span><span style="color:#E1E4E8">productId</span><span style="color:#9ECBFF">}:*`</span><span style="color:#E1E4E8">, </span><span style="color:#6A737D">// Wildcard for variant-specific caches</span></span>
<span class="line"><span style="color:#E1E4E8">    ];</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    await</span><span style="color:#79B8FF"> Promise</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">all</span><span style="color:#E1E4E8">(keys.</span><span style="color:#B392F0">map</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">key</span><span style="color:#F97583"> =></span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">deleteFromCache</span><span style="color:#E1E4E8">(key)));</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#6A737D">    // Also invalidate related caches</span></span>
<span class="line"><span style="color:#F97583">    await</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">invalidateSearchCache</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">    await</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">invalidateCategoryCache</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">  async</span><span style="color:#B392F0"> warmupCache</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Promise</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#79B8FF">void</span><span style="color:#E1E4E8">> {</span></span>
<span class="line"><span style="color:#6A737D">    // Pre-populate cache with frequently accessed data</span></span>
<span class="line"><span style="color:#E1E4E8">    console.</span><span style="color:#B392F0">log</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'Starting cache warmup...'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // Warm up top products</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> topProducts</span><span style="color:#F97583"> =</span><span style="color:#F97583"> await</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">getTopSellingProducts</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">100</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">    await</span><span style="color:#79B8FF"> Promise</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">all</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#E1E4E8">      topProducts.</span><span style="color:#B392F0">map</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">product</span><span style="color:#F97583"> =></span><span style="color:#E1E4E8"> </span></span>
<span class="line"><span style="color:#79B8FF">        this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">setCache</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">`product:${</span><span style="color:#E1E4E8">product</span><span style="color:#9ECBFF">.</span><span style="color:#E1E4E8">id</span><span style="color:#9ECBFF">}`</span><span style="color:#E1E4E8">, product, </span><span style="color:#79B8FF">3600</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">      )</span></span>
<span class="line"><span style="color:#E1E4E8">    );</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // Warm up category tree</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> categoryTree</span><span style="color:#F97583"> =</span><span style="color:#F97583"> await</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">buildCategoryTree</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">    await</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">setCache</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'categories:tree'</span><span style="color:#E1E4E8">, categoryTree, </span><span style="color:#79B8FF">7200</span><span style="color:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // Warm up popular search terms</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> popularSearches</span><span style="color:#F97583"> =</span><span style="color:#F97583"> await</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">getPopularSearchTerms</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">50</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">    await</span><span style="color:#79B8FF"> Promise</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">all</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#E1E4E8">      popularSearches.</span><span style="color:#B392F0">map</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">async</span><span style="color:#E1E4E8"> (</span><span style="color:#FFAB70">term</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">        const</span><span style="color:#79B8FF"> results</span><span style="color:#F97583"> =</span><span style="color:#F97583"> await</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.searchService.</span><span style="color:#B392F0">search</span><span style="color:#E1E4E8">(term);</span></span>
<span class="line"><span style="color:#F97583">        const</span><span style="color:#79B8FF"> cacheKey</span><span style="color:#F97583"> =</span><span style="color:#9ECBFF"> `search:${</span><span style="color:#79B8FF">this</span><span style="color:#9ECBFF">.</span><span style="color:#B392F0">hashSearchTerm</span><span style="color:#9ECBFF">(</span><span style="color:#E1E4E8">term</span><span style="color:#9ECBFF">)</span><span style="color:#9ECBFF">}`</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">        await</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">setCache</span><span style="color:#E1E4E8">(cacheKey, results, </span><span style="color:#79B8FF">900</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">      })</span></span>
<span class="line"><span style="color:#E1E4E8">    );</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    console.</span><span style="color:#B392F0">log</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'Cache warmup completed'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre>
<h3 id="2-database-optimization">2. Database Optimization</h3>
<p>Optimize database queries and structure for e-commerce workloads.</p>
<p><strong>Database Schema Optimization</strong></p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="sql"><code><span class="line"><span style="color:#6A737D">-- Optimized product table with proper indexing</span></span>
<span class="line"><span style="color:#F97583">CREATE</span><span style="color:#F97583"> TABLE</span><span style="color:#B392F0"> products</span><span style="color:#E1E4E8"> (</span></span>
<span class="line"><span style="color:#E1E4E8">    id UUID </span><span style="color:#F97583">PRIMARY KEY</span><span style="color:#F97583"> DEFAULT</span><span style="color:#E1E4E8"> gen_random_uuid(),</span></span>
<span class="line"><span style="color:#F97583">    name</span><span style="color:#F97583"> VARCHAR</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">255</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">NOT NULL</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    slug </span><span style="color:#F97583">VARCHAR</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">255</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">UNIQUE</span><span style="color:#F97583"> NOT NULL</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#F97583">    description</span><span style="color:#F97583"> TEXT</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    category_id UUID </span><span style="color:#F97583">NOT NULL</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    brand_id UUID,</span></span>
<span class="line"><span style="color:#E1E4E8">    base_price </span><span style="color:#F97583">DECIMAL</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">10</span><span style="color:#E1E4E8">,</span><span style="color:#79B8FF">2</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">NOT NULL</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    sale_price </span><span style="color:#F97583">DECIMAL</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">10</span><span style="color:#E1E4E8">,</span><span style="color:#79B8FF">2</span><span style="color:#E1E4E8">),</span></span>
<span class="line"><span style="color:#E1E4E8">    inventory_quantity </span><span style="color:#F97583">INTEGER</span><span style="color:#F97583"> DEFAULT</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    reserved_quantity </span><span style="color:#F97583">INTEGER</span><span style="color:#F97583"> DEFAULT</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    is_active </span><span style="color:#F97583">BOOLEAN</span><span style="color:#F97583"> DEFAULT</span><span style="color:#E1E4E8"> true,</span></span>
<span class="line"><span style="color:#E1E4E8">    seo_title </span><span style="color:#F97583">VARCHAR</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">255</span><span style="color:#E1E4E8">),</span></span>
<span class="line"><span style="color:#E1E4E8">    seo_description </span><span style="color:#F97583">TEXT</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    search_keywords </span><span style="color:#F97583">TEXT</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    rating_average </span><span style="color:#F97583">DECIMAL</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">3</span><span style="color:#E1E4E8">,</span><span style="color:#79B8FF">2</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">DEFAULT</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    rating_count </span><span style="color:#F97583">INTEGER</span><span style="color:#F97583"> DEFAULT</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    created_at </span><span style="color:#F97583">TIMESTAMP</span><span style="color:#F97583"> DEFAULT</span><span style="color:#E1E4E8"> CURRENT_TIMESTAMP,</span></span>
<span class="line"><span style="color:#E1E4E8">    updated_at </span><span style="color:#F97583">TIMESTAMP</span><span style="color:#F97583"> DEFAULT</span><span style="color:#E1E4E8"> CURRENT_TIMESTAMP</span></span>
<span class="line"><span style="color:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">-- Indexes for product search and filtering</span></span>
<span class="line"><span style="color:#F97583">CREATE</span><span style="color:#F97583"> INDEX</span><span style="color:#B392F0"> idx_products_category_active</span><span style="color:#F97583"> ON</span><span style="color:#E1E4E8"> products(category_id, is_active);</span></span>
<span class="line"><span style="color:#F97583">CREATE</span><span style="color:#F97583"> INDEX</span><span style="color:#B392F0"> idx_products_brand_active</span><span style="color:#F97583"> ON</span><span style="color:#E1E4E8"> products(brand_id, is_active);</span></span>
<span class="line"><span style="color:#F97583">CREATE</span><span style="color:#F97583"> INDEX</span><span style="color:#B392F0"> idx_products_price_range</span><span style="color:#F97583"> ON</span><span style="color:#E1E4E8"> products(base_price) </span><span style="color:#F97583">WHERE</span><span style="color:#E1E4E8"> is_active </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> true;</span></span>
<span class="line"><span style="color:#F97583">CREATE</span><span style="color:#F97583"> INDEX</span><span style="color:#B392F0"> idx_products_inventory</span><span style="color:#F97583"> ON</span><span style="color:#E1E4E8"> products(inventory_quantity) </span><span style="color:#F97583">WHERE</span><span style="color:#E1E4E8"> is_active </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> true;</span></span>
<span class="line"><span style="color:#F97583">CREATE</span><span style="color:#F97583"> INDEX</span><span style="color:#B392F0"> idx_products_rating</span><span style="color:#F97583"> ON</span><span style="color:#E1E4E8"> products(rating_average </span><span style="color:#F97583">DESC</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">WHERE</span><span style="color:#E1E4E8"> is_active </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> true;</span></span>
<span class="line"><span style="color:#F97583">CREATE</span><span style="color:#F97583"> INDEX</span><span style="color:#B392F0"> idx_products_created_at</span><span style="color:#F97583"> ON</span><span style="color:#E1E4E8"> products(created_at </span><span style="color:#F97583">DESC</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">WHERE</span><span style="color:#E1E4E8"> is_active </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> true;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">-- Full-text search index</span></span>
<span class="line"><span style="color:#F97583">CREATE</span><span style="color:#F97583"> INDEX</span><span style="color:#B392F0"> idx_products_search</span><span style="color:#F97583"> ON</span><span style="color:#E1E4E8"> products </span><span style="color:#F97583">USING</span><span style="color:#E1E4E8"> gin(to_tsvector(</span><span style="color:#9ECBFF">'english'</span><span style="color:#E1E4E8">, </span></span>
<span class="line"><span style="color:#79B8FF">    coalesce</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">name</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">''</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">||</span><span style="color:#9ECBFF"> ' '</span><span style="color:#F97583"> ||</span><span style="color:#E1E4E8"> </span></span>
<span class="line"><span style="color:#79B8FF">    coalesce</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">description</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">''</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">||</span><span style="color:#9ECBFF"> ' '</span><span style="color:#F97583"> ||</span><span style="color:#E1E4E8"> </span></span>
<span class="line"><span style="color:#79B8FF">    coalesce</span><span style="color:#E1E4E8">(search_keywords, </span><span style="color:#9ECBFF">''</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">-- Optimized order table</span></span>
<span class="line"><span style="color:#F97583">CREATE</span><span style="color:#F97583"> TABLE</span><span style="color:#B392F0"> orders</span><span style="color:#E1E4E8"> (</span></span>
<span class="line"><span style="color:#E1E4E8">    id UUID </span><span style="color:#F97583">PRIMARY KEY</span><span style="color:#F97583"> DEFAULT</span><span style="color:#E1E4E8"> gen_random_uuid(),</span></span>
<span class="line"><span style="color:#E1E4E8">    customer_id UUID </span><span style="color:#F97583">NOT NULL</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    order_number </span><span style="color:#F97583">VARCHAR</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">50</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">UNIQUE</span><span style="color:#F97583"> NOT NULL</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#F97583">    status</span><span style="color:#E1E4E8"> order_status_enum </span><span style="color:#F97583">NOT NULL</span><span style="color:#F97583"> DEFAULT</span><span style="color:#9ECBFF"> 'pending'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    subtotal </span><span style="color:#F97583">DECIMAL</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">10</span><span style="color:#E1E4E8">,</span><span style="color:#79B8FF">2</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">NOT NULL</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    tax_amount </span><span style="color:#F97583">DECIMAL</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">10</span><span style="color:#E1E4E8">,</span><span style="color:#79B8FF">2</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">NOT NULL</span><span style="color:#F97583"> DEFAULT</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    shipping_amount </span><span style="color:#F97583">DECIMAL</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">10</span><span style="color:#E1E4E8">,</span><span style="color:#79B8FF">2</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">NOT NULL</span><span style="color:#F97583"> DEFAULT</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    discount_amount </span><span style="color:#F97583">DECIMAL</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">10</span><span style="color:#E1E4E8">,</span><span style="color:#79B8FF">2</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">NOT NULL</span><span style="color:#F97583"> DEFAULT</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    total_amount </span><span style="color:#F97583">DECIMAL</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">10</span><span style="color:#E1E4E8">,</span><span style="color:#79B8FF">2</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">NOT NULL</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    currency </span><span style="color:#F97583">VARCHAR</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">3</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">NOT NULL</span><span style="color:#F97583"> DEFAULT</span><span style="color:#9ECBFF"> 'USD'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    payment_status </span><span style="color:#F97583">VARCHAR</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">50</span><span style="color:#E1E4E8">),</span></span>
<span class="line"><span style="color:#E1E4E8">    payment_provider </span><span style="color:#F97583">VARCHAR</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">50</span><span style="color:#E1E4E8">),</span></span>
<span class="line"><span style="color:#E1E4E8">    payment_transaction_id </span><span style="color:#F97583">VARCHAR</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">255</span><span style="color:#E1E4E8">),</span></span>
<span class="line"><span style="color:#E1E4E8">    shipping_address JSONB,</span></span>
<span class="line"><span style="color:#E1E4E8">    billing_address JSONB,</span></span>
<span class="line"><span style="color:#E1E4E8">    notes </span><span style="color:#F97583">TEXT</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">    created_at </span><span style="color:#F97583">TIMESTAMP</span><span style="color:#F97583"> DEFAULT</span><span style="color:#E1E4E8"> CURRENT_TIMESTAMP,</span></span>
<span class="line"><span style="color:#E1E4E8">    updated_at </span><span style="color:#F97583">TIMESTAMP</span><span style="color:#F97583"> DEFAULT</span><span style="color:#E1E4E8"> CURRENT_TIMESTAMP</span></span>
<span class="line"><span style="color:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">-- Indexes for order queries</span></span>
<span class="line"><span style="color:#F97583">CREATE</span><span style="color:#F97583"> INDEX</span><span style="color:#B392F0"> idx_orders_customer_created</span><span style="color:#F97583"> ON</span><span style="color:#E1E4E8"> orders(customer_id, created_at </span><span style="color:#F97583">DESC</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">CREATE</span><span style="color:#F97583"> INDEX</span><span style="color:#B392F0"> idx_orders_status_created</span><span style="color:#F97583"> ON</span><span style="color:#E1E4E8"> orders(</span><span style="color:#F97583">status</span><span style="color:#E1E4E8">, created_at </span><span style="color:#F97583">DESC</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">CREATE</span><span style="color:#F97583"> INDEX</span><span style="color:#B392F0"> idx_orders_number</span><span style="color:#F97583"> ON</span><span style="color:#E1E4E8"> orders(order_number);</span></span>
<span class="line"><span style="color:#F97583">CREATE</span><span style="color:#F97583"> INDEX</span><span style="color:#B392F0"> idx_orders_payment_status</span><span style="color:#F97583"> ON</span><span style="color:#E1E4E8"> orders(payment_status) </span><span style="color:#F97583">WHERE</span><span style="color:#E1E4E8"> payment_status </span><span style="color:#F97583">IS NOT NULL</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">-- Partitioning for large order tables (optional, for high-volume stores)</span></span>
<span class="line"><span style="color:#F97583">CREATE</span><span style="color:#F97583"> TABLE</span><span style="color:#B392F0"> orders_2024</span><span style="color:#F97583"> PARTITION</span><span style="color:#E1E4E8"> OF orders </span></span>
<span class="line"><span style="color:#F97583">FOR</span><span style="color:#F97583"> VALUES</span><span style="color:#F97583"> FROM</span><span style="color:#E1E4E8"> (</span><span style="color:#9ECBFF">'2024-01-01'</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">TO</span><span style="color:#E1E4E8"> (</span><span style="color:#9ECBFF">'2025-01-01'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"></span></code></pre>
<p><strong>Query Optimization Examples</strong></p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="typescript"><code><span class="line"><span style="color:#F97583">class</span><span style="color:#B392F0"> OptimizedProductRepository</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">  async</span><span style="color:#B392F0"> getProductsWithFilters</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">filters</span><span style="color:#F97583">:</span><span style="color:#B392F0"> ProductFilters</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Promise</span><span style="color:#E1E4E8">&#x3C;{ </span><span style="color:#FFAB70">products</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Product</span><span style="color:#E1E4E8">[]; </span><span style="color:#FFAB70">total</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> number</span><span style="color:#E1E4E8"> }> {</span></span>
<span class="line"><span style="color:#6A737D">    // Build optimized query with proper indexing</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> query </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">queryBuilder</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'products'</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">      .</span><span style="color:#B392F0">select</span><span style="color:#E1E4E8">([</span></span>
<span class="line"><span style="color:#9ECBFF">        'products.*'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">        'categories.name as category_name'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">        'brands.name as brand_name'</span></span>
<span class="line"><span style="color:#E1E4E8">      ])</span></span>
<span class="line"><span style="color:#E1E4E8">      .</span><span style="color:#B392F0">leftJoin</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'categories'</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'categories.id'</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'products.category_id'</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">      .</span><span style="color:#B392F0">leftJoin</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'brands'</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'brands.id'</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'products.brand_id'</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">      .</span><span style="color:#B392F0">where</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'products.is_active'</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">true</span><span style="color:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // Apply filters with index-friendly conditions</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (filters.categoryId) {</span></span>
<span class="line"><span style="color:#E1E4E8">      query </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> query.</span><span style="color:#B392F0">where</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'products.category_id'</span><span style="color:#E1E4E8">, filters.categoryId);</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (filters.brandIds?.</span><span style="color:#79B8FF">length</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">      query </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> query.</span><span style="color:#B392F0">whereIn</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'products.brand_id'</span><span style="color:#E1E4E8">, filters.brandIds);</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (filters.priceRange) {</span></span>
<span class="line"><span style="color:#E1E4E8">      query </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> query</span></span>
<span class="line"><span style="color:#E1E4E8">        .</span><span style="color:#B392F0">where</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'products.base_price'</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'>='</span><span style="color:#E1E4E8">, filters.priceRange.min)</span></span>
<span class="line"><span style="color:#E1E4E8">        .</span><span style="color:#B392F0">where</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'products.base_price'</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'&#x3C;='</span><span style="color:#E1E4E8">, filters.priceRange.max);</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (filters.inStockOnly) {</span></span>
<span class="line"><span style="color:#E1E4E8">      query </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> query.</span><span style="color:#B392F0">where</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'products.inventory_quantity'</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'>'</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (filters.searchTerm) {</span></span>
<span class="line"><span style="color:#6A737D">      // Use full-text search for better performance</span></span>
<span class="line"><span style="color:#E1E4E8">      query </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> query.</span><span style="color:#B392F0">whereRaw</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#9ECBFF">        `to_tsvector('english', </span></span>
<span class="line"><span style="color:#9ECBFF">          coalesce(products.name, '') || ' ' || </span></span>
<span class="line"><span style="color:#9ECBFF">          coalesce(products.description, '') || ' ' || </span></span>
<span class="line"><span style="color:#9ECBFF">          coalesce(products.search_keywords, '')</span></span>
<span class="line"><span style="color:#9ECBFF">        ) @@ plainto_tsquery('english', ?)`</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">        [filters.searchTerm]</span></span>
<span class="line"><span style="color:#E1E4E8">      );</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // Apply sorting with index support</span></span>
<span class="line"><span style="color:#F97583">    switch</span><span style="color:#E1E4E8"> (filters.sortBy) {</span></span>
<span class="line"><span style="color:#F97583">      case</span><span style="color:#9ECBFF"> 'price_asc'</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">        query </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> query.</span><span style="color:#B392F0">orderBy</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'products.base_price'</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'asc'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">        break</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">      case</span><span style="color:#9ECBFF"> 'price_desc'</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">        query </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> query.</span><span style="color:#B392F0">orderBy</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'products.base_price'</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'desc'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">        break</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">      case</span><span style="color:#9ECBFF"> 'rating'</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">        query </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> query.</span><span style="color:#B392F0">orderBy</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'products.rating_average'</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'desc'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">        break</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">      case</span><span style="color:#9ECBFF"> 'newest'</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">        query </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> query.</span><span style="color:#B392F0">orderBy</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'products.created_at'</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'desc'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">        break</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">      default</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">        query </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> query.</span><span style="color:#B392F0">orderBy</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'products.created_at'</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'desc'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // Get total count for pagination (use separate optimized query)</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> countQuery</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> query.</span><span style="color:#B392F0">clone</span><span style="color:#E1E4E8">().</span><span style="color:#B392F0">clearSelect</span><span style="color:#E1E4E8">().</span><span style="color:#B392F0">count</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'* as total'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#E1E4E8"> [{ </span><span style="color:#79B8FF">total</span><span style="color:#E1E4E8"> }] </span><span style="color:#F97583">=</span><span style="color:#F97583"> await</span><span style="color:#E1E4E8"> countQuery;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // Apply pagination</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> products</span><span style="color:#F97583"> =</span><span style="color:#F97583"> await</span><span style="color:#E1E4E8"> query</span></span>
<span class="line"><span style="color:#E1E4E8">      .</span><span style="color:#B392F0">limit</span><span style="color:#E1E4E8">(filters.limit </span><span style="color:#F97583">||</span><span style="color:#79B8FF"> 20</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">      .</span><span style="color:#B392F0">offset</span><span style="color:#E1E4E8">((filters.page </span><span style="color:#F97583">-</span><span style="color:#79B8FF"> 1</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">*</span><span style="color:#E1E4E8"> (filters.limit </span><span style="color:#F97583">||</span><span style="color:#79B8FF"> 20</span><span style="color:#E1E4E8">));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> { products, total: </span><span style="color:#B392F0">parseInt</span><span style="color:#E1E4E8">(total </span><span style="color:#F97583">as</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">) };</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">  async</span><span style="color:#B392F0"> getOrderHistory</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">customerId</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">page</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> number</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> 1</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">limit</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> number</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> 10</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Promise</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">Order</span><span style="color:#E1E4E8">[]> {</span></span>
<span class="line"><span style="color:#6A737D">    // Optimized query using customer index</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#F97583"> await</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">queryBuilder</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'orders'</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">      .</span><span style="color:#B392F0">select</span><span style="color:#E1E4E8">([</span></span>
<span class="line"><span style="color:#9ECBFF">        'orders.*'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#79B8FF">        this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">raw</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'COUNT(order_items.id) as item_count'</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">      ])</span></span>
<span class="line"><span style="color:#E1E4E8">      .</span><span style="color:#B392F0">leftJoin</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'order_items'</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'order_items.order_id'</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'orders.id'</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">      .</span><span style="color:#B392F0">where</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'orders.customer_id'</span><span style="color:#E1E4E8">, customerId)</span></span>
<span class="line"><span style="color:#E1E4E8">      .</span><span style="color:#B392F0">groupBy</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'orders.id'</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">      .</span><span style="color:#B392F0">orderBy</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'orders.created_at'</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'desc'</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">      .</span><span style="color:#B392F0">limit</span><span style="color:#E1E4E8">(limit)</span></span>
<span class="line"><span style="color:#E1E4E8">      .</span><span style="color:#B392F0">offset</span><span style="color:#E1E4E8">((page </span><span style="color:#F97583">-</span><span style="color:#79B8FF"> 1</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">*</span><span style="color:#E1E4E8"> limit);</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre>
<h2 id="security-implementation">Security Implementation</h2>
<h3 id="1-data-protection-and-compliance">1. Data Protection and Compliance</h3>
<p>Implement comprehensive security measures for customer data protection.</p>
<p><strong>PCI DSS Compliance Framework</strong></p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="typescript"><code><span class="line"><span style="color:#F97583">interface</span><span style="color:#B392F0"> SecurityConfig</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#FFAB70">  encryption</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#FFAB70">    algorithm</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#FFAB70">    keyRotationDays</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> number</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#FFAB70">    atRestEncryption</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> boolean</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#FFAB70">    inTransitEncryption</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> boolean</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">  };</span></span>
<span class="line"><span style="color:#FFAB70">  accessControl</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#FFAB70">    mfaRequired</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> boolean</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#FFAB70">    sessionTimeout</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> number</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#FFAB70">    passwordPolicy</span><span style="color:#F97583">:</span><span style="color:#B392F0"> PasswordPolicy</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#FFAB70">    roleBasedAccess</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> boolean</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">  };</span></span>
<span class="line"><span style="color:#FFAB70">  auditing</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#FFAB70">    logAllAccess</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> boolean</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#FFAB70">    retentionDays</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> number</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#FFAB70">    realTimeMonitoring</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> boolean</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">  };</span></span>
<span class="line"><span style="color:#FFAB70">  compliance</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#FFAB70">    pciDssLevel</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> 1</span><span style="color:#F97583"> |</span><span style="color:#79B8FF"> 2</span><span style="color:#F97583"> |</span><span style="color:#79B8FF"> 3</span><span style="color:#F97583"> |</span><span style="color:#79B8FF"> 4</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#FFAB70">    gdprCompliant</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> boolean</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#FFAB70">    dataRetentionPolicy</span><span style="color:#F97583">:</span><span style="color:#B392F0"> DataRetentionPolicy</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">  };</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">class</span><span style="color:#B392F0"> SecurityManager</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">  private</span><span style="color:#FFAB70"> config</span><span style="color:#F97583">:</span><span style="color:#B392F0"> SecurityConfig</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">  </span></span>
<span class="line"><span style="color:#F97583">  constructor</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">config</span><span style="color:#F97583">:</span><span style="color:#B392F0"> SecurityConfig</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#79B8FF">    this</span><span style="color:#E1E4E8">.config </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> config;</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">  // Encrypt sensitive data before storage</span></span>
<span class="line"><span style="color:#F97583">  async</span><span style="color:#B392F0"> encryptSensitiveData</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">data</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> any</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">dataType</span><span style="color:#F97583">:</span><span style="color:#9ECBFF"> 'payment'</span><span style="color:#F97583"> |</span><span style="color:#9ECBFF"> 'personal'</span><span style="color:#F97583"> |</span><span style="color:#9ECBFF"> 'authentication'</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Promise</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#79B8FF">string</span><span style="color:#E1E4E8">> {</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> key</span><span style="color:#F97583"> =</span><span style="color:#F97583"> await</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">getEncryptionKey</span><span style="color:#E1E4E8">(dataType);</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> iv</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> crypto.</span><span style="color:#B392F0">randomBytes</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">16</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> cipher</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> crypto.</span><span style="color:#B392F0">createCipher</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.config.encryption.algorithm, key);</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> encrypted </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> cipher.</span><span style="color:#B392F0">update</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">JSON</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">stringify</span><span style="color:#E1E4E8">(data), </span><span style="color:#9ECBFF">'utf8'</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'hex'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">    encrypted </span><span style="color:#F97583">+=</span><span style="color:#E1E4E8"> cipher.</span><span style="color:#B392F0">final</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'hex'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#6A737D">    // Store IV with encrypted data</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> iv.</span><span style="color:#B392F0">toString</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'hex'</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">+</span><span style="color:#9ECBFF"> ':'</span><span style="color:#F97583"> +</span><span style="color:#E1E4E8"> encrypted;</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">  async</span><span style="color:#B392F0"> decryptSensitiveData</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">encryptedData</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">dataType</span><span style="color:#F97583">:</span><span style="color:#9ECBFF"> 'payment'</span><span style="color:#F97583"> |</span><span style="color:#9ECBFF"> 'personal'</span><span style="color:#F97583"> |</span><span style="color:#9ECBFF"> 'authentication'</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Promise</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#79B8FF">any</span><span style="color:#E1E4E8">> {</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#E1E4E8"> [</span><span style="color:#79B8FF">ivHex</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">encrypted</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> encryptedData.</span><span style="color:#B392F0">split</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">':'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> iv</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> Buffer.</span><span style="color:#B392F0">from</span><span style="color:#E1E4E8">(ivHex, </span><span style="color:#9ECBFF">'hex'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> key</span><span style="color:#F97583"> =</span><span style="color:#F97583"> await</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">getEncryptionKey</span><span style="color:#E1E4E8">(dataType);</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> decipher</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> crypto.</span><span style="color:#B392F0">createDecipher</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.config.encryption.algorithm, key);</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> decrypted </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> decipher.</span><span style="color:#B392F0">update</span><span style="color:#E1E4E8">(encrypted, </span><span style="color:#9ECBFF">'hex'</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'utf8'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">    decrypted </span><span style="color:#F97583">+=</span><span style="color:#E1E4E8"> decipher.</span><span style="color:#B392F0">final</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'utf8'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#79B8FF"> JSON</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">parse</span><span style="color:#E1E4E8">(decrypted);</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">  // Audit logging for compliance</span></span>
<span class="line"><span style="color:#F97583">  async</span><span style="color:#B392F0"> logSecurityEvent</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">event</span><span style="color:#F97583">:</span><span style="color:#B392F0"> SecurityEvent</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Promise</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#79B8FF">void</span><span style="color:#E1E4E8">> {</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> auditLog</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">      eventId: </span><span style="color:#B392F0">generateUuid</span><span style="color:#E1E4E8">(),</span></span>
<span class="line"><span style="color:#E1E4E8">      timestamp: </span><span style="color:#F97583">new</span><span style="color:#B392F0"> Date</span><span style="color:#E1E4E8">(),</span></span>
<span class="line"><span style="color:#E1E4E8">      eventType: event.type,</span></span>
<span class="line"><span style="color:#E1E4E8">      userId: event.userId,</span></span>
<span class="line"><span style="color:#E1E4E8">      sessionId: event.sessionId,</span></span>
<span class="line"><span style="color:#E1E4E8">      ipAddress: event.ipAddress,</span></span>
<span class="line"><span style="color:#E1E4E8">      userAgent: event.userAgent,</span></span>
<span class="line"><span style="color:#E1E4E8">      resource: event.resource,</span></span>
<span class="line"><span style="color:#E1E4E8">      action: event.action,</span></span>
<span class="line"><span style="color:#E1E4E8">      result: event.result,</span></span>
<span class="line"><span style="color:#E1E4E8">      riskScore: event.riskScore,</span></span>
<span class="line"><span style="color:#E1E4E8">      metadata: event.metadata</span></span>
<span class="line"><span style="color:#E1E4E8">    };</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // Store in secure audit database</span></span>
<span class="line"><span style="color:#F97583">    await</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.auditRepository.</span><span style="color:#B392F0">create</span><span style="color:#E1E4E8">(auditLog);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // Real-time alerting for high-risk events</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (event.riskScore </span><span style="color:#F97583">></span><span style="color:#79B8FF"> 8</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">      await</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.alertingService.</span><span style="color:#B392F0">sendSecurityAlert</span><span style="color:#E1E4E8">(auditLog);</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">  // Data anonymization for GDPR compliance</span></span>
<span class="line"><span style="color:#F97583">  async</span><span style="color:#B392F0"> anonymizeCustomerData</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">customerId</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Promise</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#79B8FF">void</span><span style="color:#E1E4E8">> {</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> anonymizedData</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">      email: </span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">anonymizeEmail</span><span style="color:#E1E4E8">(),</span></span>
<span class="line"><span style="color:#E1E4E8">      name: </span><span style="color:#9ECBFF">'Anonymous User'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">      phone: </span><span style="color:#79B8FF">null</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">      addresses: [],</span></span>
<span class="line"><span style="color:#E1E4E8">      dateOfBirth: </span><span style="color:#79B8FF">null</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">      preferences: {}</span></span>
<span class="line"><span style="color:#E1E4E8">    };</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // Update customer record with anonymized data</span></span>
<span class="line"><span style="color:#F97583">    await</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.customerRepository.</span><span style="color:#B392F0">update</span><span style="color:#E1E4E8">(customerId, anonymizedData);</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#6A737D">    // Anonymize related order data</span></span>
<span class="line"><span style="color:#F97583">    await</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">anonymizeOrderData</span><span style="color:#E1E4E8">(customerId);</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#6A737D">    // Log anonymization action</span></span>
<span class="line"><span style="color:#F97583">    await</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">logSecurityEvent</span><span style="color:#E1E4E8">({</span></span>
<span class="line"><span style="color:#E1E4E8">      type: </span><span style="color:#9ECBFF">'data_anonymization'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">      userId: customerId,</span></span>
<span class="line"><span style="color:#E1E4E8">      action: </span><span style="color:#9ECBFF">'anonymize_customer_data'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">      result: </span><span style="color:#9ECBFF">'success'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">      riskScore: </span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">      metadata: { reason: </span><span style="color:#9ECBFF">'gdpr_request'</span><span style="color:#E1E4E8"> }</span></span>
<span class="line"><span style="color:#E1E4E8">    });</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">  private</span><span style="color:#B392F0"> anonymizeEmail</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#9ECBFF"> `anonymous_${</span><span style="color:#B392F0">generateUuid</span><span style="color:#9ECBFF">().</span><span style="color:#B392F0">substring</span><span style="color:#9ECBFF">(</span><span style="color:#79B8FF">0</span><span style="color:#9ECBFF">, </span><span style="color:#79B8FF">8</span><span style="color:#9ECBFF">)</span><span style="color:#9ECBFF">}@deleted.com`</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre>
<h3 id="2-fraud-detection-and-prevention">2. Fraud Detection and Prevention</h3>
<p>Implement real-time fraud detection to protect against malicious activities.</p>
<p><strong>Fraud Detection Engine</strong></p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="typescript"><code><span class="line"><span style="color:#F97583">interface</span><span style="color:#B392F0"> FraudRule</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#FFAB70">  id</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#FFAB70">  name</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#FFAB70">  enabled</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> boolean</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#FFAB70">  weight</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> number</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#FFAB70">  conditions</span><span style="color:#F97583">:</span><span style="color:#B392F0"> FraudCondition</span><span style="color:#E1E4E8">[];</span></span>
<span class="line"><span style="color:#FFAB70">  action</span><span style="color:#F97583">:</span><span style="color:#9ECBFF"> 'allow'</span><span style="color:#F97583"> |</span><span style="color:#9ECBFF"> 'review'</span><span style="color:#F97583"> |</span><span style="color:#9ECBFF"> 'block'</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">interface</span><span style="color:#B392F0"> FraudCondition</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#FFAB70">  field</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#FFAB70">  operator</span><span style="color:#F97583">:</span><span style="color:#9ECBFF"> 'equals'</span><span style="color:#F97583"> |</span><span style="color:#9ECBFF"> 'greater_than'</span><span style="color:#F97583"> |</span><span style="color:#9ECBFF"> 'less_than'</span><span style="color:#F97583"> |</span><span style="color:#9ECBFF"> 'contains'</span><span style="color:#F97583"> |</span><span style="color:#9ECBFF"> 'in_list'</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#FFAB70">  value</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> any</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">interface</span><span style="color:#B392F0"> FraudScore</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#FFAB70">  totalScore</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> number</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#FFAB70">  triggeredRules</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">[];</span></span>
<span class="line"><span style="color:#FFAB70">  recommendation</span><span style="color:#F97583">:</span><span style="color:#9ECBFF"> 'approve'</span><span style="color:#F97583"> |</span><span style="color:#9ECBFF"> 'review'</span><span style="color:#F97583"> |</span><span style="color:#9ECBFF"> 'decline'</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#FFAB70">  reasons</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">[];</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">class</span><span style="color:#B392F0"> FraudDetectionEngine</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">  private</span><span style="color:#FFAB70"> rules</span><span style="color:#F97583">:</span><span style="color:#B392F0"> FraudRule</span><span style="color:#E1E4E8">[] </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> [];</span></span>
<span class="line"><span style="color:#F97583">  private</span><span style="color:#FFAB70"> mlModel</span><span style="color:#F97583">:</span><span style="color:#B392F0"> MLFraudModel</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">  constructor</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#79B8FF">    this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">loadFraudRules</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#79B8FF">    this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">initializeMLModel</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">  async</span><span style="color:#B392F0"> analyzeTransaction</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">transaction</span><span style="color:#F97583">:</span><span style="color:#B392F0"> TransactionData</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Promise</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">FraudScore</span><span style="color:#E1E4E8">> {</span></span>
<span class="line"><span style="color:#6A737D">    // Rule-based fraud detection</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> ruleScore</span><span style="color:#F97583"> =</span><span style="color:#F97583"> await</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">evaluateRules</span><span style="color:#E1E4E8">(transaction);</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#6A737D">    // Machine learning fraud detection</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> mlScore</span><span style="color:#F97583"> =</span><span style="color:#F97583"> await</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">evaluateMLModel</span><span style="color:#E1E4E8">(transaction);</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#6A737D">    // Velocity checks</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> velocityScore</span><span style="color:#F97583"> =</span><span style="color:#F97583"> await</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">checkVelocity</span><span style="color:#E1E4E8">(transaction);</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#6A737D">    // Device fingerprinting</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> deviceScore</span><span style="color:#F97583"> =</span><span style="color:#F97583"> await</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">analyzeDevice</span><span style="color:#E1E4E8">(transaction);</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#6A737D">    // Combine scores</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> totalScore</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">combineScores</span><span style="color:#E1E4E8">({</span></span>
<span class="line"><span style="color:#E1E4E8">      rules: ruleScore.score,</span></span>
<span class="line"><span style="color:#E1E4E8">      ml: mlScore,</span></span>
<span class="line"><span style="color:#E1E4E8">      velocity: velocityScore,</span></span>
<span class="line"><span style="color:#E1E4E8">      device: deviceScore</span></span>
<span class="line"><span style="color:#E1E4E8">    });</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">      totalScore,</span></span>
<span class="line"><span style="color:#E1E4E8">      triggeredRules: ruleScore.triggeredRules,</span></span>
<span class="line"><span style="color:#E1E4E8">      recommendation: </span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">getRecommendation</span><span style="color:#E1E4E8">(totalScore),</span></span>
<span class="line"><span style="color:#E1E4E8">      reasons: </span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">buildReasonsList</span><span style="color:#E1E4E8">(ruleScore, mlScore, velocityScore, deviceScore)</span></span>
<span class="line"><span style="color:#E1E4E8">    };</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">  private</span><span style="color:#F97583"> async</span><span style="color:#B392F0"> evaluateRules</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">transaction</span><span style="color:#F97583">:</span><span style="color:#B392F0"> TransactionData</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Promise</span><span style="color:#E1E4E8">&#x3C;{ </span><span style="color:#FFAB70">score</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> number</span><span style="color:#E1E4E8">; </span><span style="color:#FFAB70">triggeredRules</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">[] }> {</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> totalScore </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> triggeredRules</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">[] </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> [];</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    for</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">const</span><span style="color:#79B8FF"> rule</span><span style="color:#F97583"> of</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.rules.</span><span style="color:#B392F0">filter</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">r</span><span style="color:#F97583"> =></span><span style="color:#E1E4E8"> r.enabled)) {</span></span>
<span class="line"><span style="color:#F97583">      if</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">await</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">evaluateRule</span><span style="color:#E1E4E8">(rule, transaction)) {</span></span>
<span class="line"><span style="color:#E1E4E8">        totalScore </span><span style="color:#F97583">+=</span><span style="color:#E1E4E8"> rule.weight;</span></span>
<span class="line"><span style="color:#E1E4E8">        triggeredRules.</span><span style="color:#B392F0">push</span><span style="color:#E1E4E8">(rule.id);</span></span>
<span class="line"><span style="color:#E1E4E8">      }</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> { score: totalScore, triggeredRules };</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">  private</span><span style="color:#F97583"> async</span><span style="color:#B392F0"> evaluateRule</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">rule</span><span style="color:#F97583">:</span><span style="color:#B392F0"> FraudRule</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">transaction</span><span style="color:#F97583">:</span><span style="color:#B392F0"> TransactionData</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Promise</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#79B8FF">boolean</span><span style="color:#E1E4E8">> {</span></span>
<span class="line"><span style="color:#F97583">    for</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">const</span><span style="color:#79B8FF"> condition</span><span style="color:#F97583"> of</span><span style="color:#E1E4E8"> rule.conditions) {</span></span>
<span class="line"><span style="color:#F97583">      if</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">!</span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">evaluateCondition</span><span style="color:#E1E4E8">(condition, transaction)) {</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#79B8FF"> false</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">      }</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#79B8FF"> true</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">  private</span><span style="color:#B392F0"> evaluateCondition</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">condition</span><span style="color:#F97583">:</span><span style="color:#B392F0"> FraudCondition</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">transaction</span><span style="color:#F97583">:</span><span style="color:#B392F0"> TransactionData</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> boolean</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> fieldValue</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">getFieldValue</span><span style="color:#E1E4E8">(transaction, condition.field);</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#F97583">    switch</span><span style="color:#E1E4E8"> (condition.operator) {</span></span>
<span class="line"><span style="color:#F97583">      case</span><span style="color:#9ECBFF"> 'equals'</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#E1E4E8"> fieldValue </span><span style="color:#F97583">===</span><span style="color:#E1E4E8"> condition.value;</span></span>
<span class="line"><span style="color:#F97583">      case</span><span style="color:#9ECBFF"> 'greater_than'</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#E1E4E8"> fieldValue </span><span style="color:#F97583">></span><span style="color:#E1E4E8"> condition.value;</span></span>
<span class="line"><span style="color:#F97583">      case</span><span style="color:#9ECBFF"> 'less_than'</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#E1E4E8"> fieldValue </span><span style="color:#F97583">&#x3C;</span><span style="color:#E1E4E8"> condition.value;</span></span>
<span class="line"><span style="color:#F97583">      case</span><span style="color:#9ECBFF"> 'contains'</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#B392F0"> String</span><span style="color:#E1E4E8">(fieldValue).</span><span style="color:#B392F0">includes</span><span style="color:#E1E4E8">(condition.value);</span></span>
<span class="line"><span style="color:#F97583">      case</span><span style="color:#9ECBFF"> 'in_list'</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#E1E4E8"> condition.value.</span><span style="color:#B392F0">includes</span><span style="color:#E1E4E8">(fieldValue);</span></span>
<span class="line"><span style="color:#F97583">      default</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#79B8FF"> false</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">  private</span><span style="color:#F97583"> async</span><span style="color:#B392F0"> checkVelocity</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">transaction</span><span style="color:#F97583">:</span><span style="color:#B392F0"> TransactionData</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Promise</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#79B8FF">number</span><span style="color:#E1E4E8">> {</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> velocityScore </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // Check transaction frequency per customer</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> customerTransactions</span><span style="color:#F97583"> =</span><span style="color:#F97583"> await</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">getRecentTransactions</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#E1E4E8">      transaction.customerId, </span></span>
<span class="line"><span style="color:#79B8FF">      24</span><span style="color:#6A737D"> // last 24 hours</span></span>
<span class="line"><span style="color:#E1E4E8">    );</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (customerTransactions.</span><span style="color:#79B8FF">length</span><span style="color:#F97583"> ></span><span style="color:#79B8FF"> 10</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">      velocityScore </span><span style="color:#F97583">+=</span><span style="color:#79B8FF"> 30</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">    } </span><span style="color:#F97583">else</span><span style="color:#F97583"> if</span><span style="color:#E1E4E8"> (customerTransactions.</span><span style="color:#79B8FF">length</span><span style="color:#F97583"> ></span><span style="color:#79B8FF"> 5</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">      velocityScore </span><span style="color:#F97583">+=</span><span style="color:#79B8FF"> 15</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // Check transaction amount velocity</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> totalAmount</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> customerTransactions.</span><span style="color:#B392F0">reduce</span><span style="color:#E1E4E8">((</span><span style="color:#FFAB70">sum</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">tx</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> sum </span><span style="color:#F97583">+</span><span style="color:#E1E4E8"> tx.amount, </span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (totalAmount </span><span style="color:#F97583">></span><span style="color:#79B8FF"> 5000</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">      velocityScore </span><span style="color:#F97583">+=</span><span style="color:#79B8FF"> 25</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // Check failed payment attempts</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> failedAttempts</span><span style="color:#F97583"> =</span><span style="color:#F97583"> await</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">getFailedPaymentAttempts</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#E1E4E8">      transaction.customerId,</span></span>
<span class="line"><span style="color:#79B8FF">      6</span><span style="color:#6A737D"> // last 6 hours</span></span>
<span class="line"><span style="color:#E1E4E8">    );</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (failedAttempts </span><span style="color:#F97583">></span><span style="color:#79B8FF"> 3</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">      velocityScore </span><span style="color:#F97583">+=</span><span style="color:#79B8FF"> 40</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> Math.</span><span style="color:#B392F0">min</span><span style="color:#E1E4E8">(velocityScore, </span><span style="color:#79B8FF">100</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">  private</span><span style="color:#F97583"> async</span><span style="color:#B392F0"> analyzeDevice</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">transaction</span><span style="color:#F97583">:</span><span style="color:#B392F0"> TransactionData</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Promise</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#79B8FF">number</span><span style="color:#E1E4E8">> {</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> deviceScore </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> deviceFingerprint</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> transaction.deviceFingerprint;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // Check if device is known</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> isKnownDevice</span><span style="color:#F97583"> =</span><span style="color:#F97583"> await</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">isKnownDevice</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#E1E4E8">      transaction.customerId,</span></span>
<span class="line"><span style="color:#E1E4E8">      deviceFingerprint</span></span>
<span class="line"><span style="color:#E1E4E8">    );</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">!</span><span style="color:#E1E4E8">isKnownDevice) {</span></span>
<span class="line"><span style="color:#E1E4E8">      deviceScore </span><span style="color:#F97583">+=</span><span style="color:#79B8FF"> 20</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // Check device reputation</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> deviceReputation</span><span style="color:#F97583"> =</span><span style="color:#F97583"> await</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">getDeviceReputation</span><span style="color:#E1E4E8">(deviceFingerprint);</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (deviceReputation </span><span style="color:#F97583">===</span><span style="color:#9ECBFF"> 'bad'</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">      deviceScore </span><span style="color:#F97583">+=</span><span style="color:#79B8FF"> 50</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">    } </span><span style="color:#F97583">else</span><span style="color:#F97583"> if</span><span style="color:#E1E4E8"> (deviceReputation </span><span style="color:#F97583">===</span><span style="color:#9ECBFF"> 'suspicious'</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#E1E4E8">      deviceScore </span><span style="color:#F97583">+=</span><span style="color:#79B8FF"> 25</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // Check for device spoofing indicators</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (</span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">detectDeviceSpoofing</span><span style="color:#E1E4E8">(deviceFingerprint)) {</span></span>
<span class="line"><span style="color:#E1E4E8">      deviceScore </span><span style="color:#F97583">+=</span><span style="color:#79B8FF"> 30</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // Check IP geolocation vs billing address</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> ipLocation</span><span style="color:#F97583"> =</span><span style="color:#F97583"> await</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">getIPLocation</span><span style="color:#E1E4E8">(transaction.ipAddress);</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> billingLocation</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> transaction.billingAddress;</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (</span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">calculateDistance</span><span style="color:#E1E4E8">(ipLocation, billingLocation) </span><span style="color:#F97583">></span><span style="color:#79B8FF"> 1000</span><span style="color:#E1E4E8">) { </span><span style="color:#6A737D">// > 1000 km</span></span>
<span class="line"><span style="color:#E1E4E8">      deviceScore </span><span style="color:#F97583">+=</span><span style="color:#79B8FF"> 15</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> Math.</span><span style="color:#B392F0">min</span><span style="color:#E1E4E8">(deviceScore, </span><span style="color:#79B8FF">100</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">  private</span><span style="color:#B392F0"> getRecommendation</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">score</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> number</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">:</span><span style="color:#9ECBFF"> 'approve'</span><span style="color:#F97583"> |</span><span style="color:#9ECBFF"> 'review'</span><span style="color:#F97583"> |</span><span style="color:#9ECBFF"> 'decline'</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (score </span><span style="color:#F97583">&#x3C;</span><span style="color:#79B8FF"> 30</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">return</span><span style="color:#9ECBFF"> 'approve'</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (score </span><span style="color:#F97583">&#x3C;</span><span style="color:#79B8FF"> 70</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">return</span><span style="color:#9ECBFF"> 'review'</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#9ECBFF"> 'decline'</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre>
<h2 id="scalability-and-performance">Scalability and Performance</h2>
<h3 id="1-microservices-scaling-strategies">1. Microservices Scaling Strategies</h3>
<p>Implement auto-scaling and load balancing for microservices architecture.</p>
<p><strong>Kubernetes Auto-scaling Configuration</strong></p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="yaml"><code><span class="line"><span style="color:#6A737D"># Horizontal Pod Autoscaler for product service</span></span>
<span class="line"><span style="color:#85E89D">apiVersion</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">autoscaling/v2</span></span>
<span class="line"><span style="color:#85E89D">kind</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">HorizontalPodAutoscaler</span></span>
<span class="line"><span style="color:#85E89D">metadata</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#85E89D">  name</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">product-service-hpa</span></span>
<span class="line"><span style="color:#85E89D">  namespace</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">ecommerce</span></span>
<span class="line"><span style="color:#85E89D">spec</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#85E89D">  scaleTargetRef</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#85E89D">    apiVersion</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">apps/v1</span></span>
<span class="line"><span style="color:#85E89D">    kind</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">Deployment</span></span>
<span class="line"><span style="color:#85E89D">    name</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">product-service</span></span>
<span class="line"><span style="color:#85E89D">  minReplicas</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">3</span></span>
<span class="line"><span style="color:#85E89D">  maxReplicas</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">50</span></span>
<span class="line"><span style="color:#85E89D">  metrics</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">  - </span><span style="color:#85E89D">type</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">Resource</span></span>
<span class="line"><span style="color:#85E89D">    resource</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#85E89D">      name</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">cpu</span></span>
<span class="line"><span style="color:#85E89D">      target</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#85E89D">        type</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">Utilization</span></span>
<span class="line"><span style="color:#85E89D">        averageUtilization</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">70</span></span>
<span class="line"><span style="color:#E1E4E8">  - </span><span style="color:#85E89D">type</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">Resource</span></span>
<span class="line"><span style="color:#85E89D">    resource</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#85E89D">      name</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">memory</span></span>
<span class="line"><span style="color:#85E89D">      target</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#85E89D">        type</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">Utilization</span></span>
<span class="line"><span style="color:#85E89D">        averageUtilization</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">80</span></span>
<span class="line"><span style="color:#E1E4E8">  - </span><span style="color:#85E89D">type</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">Pods</span></span>
<span class="line"><span style="color:#85E89D">    pods</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#85E89D">      metric</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#85E89D">        name</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">requests_per_second</span></span>
<span class="line"><span style="color:#85E89D">      target</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#85E89D">        type</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">AverageValue</span></span>
<span class="line"><span style="color:#85E89D">        averageValue</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">"100"</span></span>
<span class="line"><span style="color:#85E89D">  behavior</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#85E89D">    scaleDown</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#85E89D">      stabilizationWindowSeconds</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">300</span></span>
<span class="line"><span style="color:#85E89D">      policies</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">      - </span><span style="color:#85E89D">type</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">Percent</span></span>
<span class="line"><span style="color:#85E89D">        value</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">50</span></span>
<span class="line"><span style="color:#85E89D">        periodSeconds</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">60</span></span>
<span class="line"><span style="color:#85E89D">    scaleUp</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#85E89D">      stabilizationWindowSeconds</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">60</span></span>
<span class="line"><span style="color:#85E89D">      policies</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">      - </span><span style="color:#85E89D">type</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">Percent</span></span>
<span class="line"><span style="color:#85E89D">        value</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">100</span></span>
<span class="line"><span style="color:#85E89D">        periodSeconds</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">15</span></span>
<span class="line"><span style="color:#E1E4E8">      - </span><span style="color:#85E89D">type</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">Pods</span></span>
<span class="line"><span style="color:#85E89D">        value</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">4</span></span>
<span class="line"><span style="color:#85E89D">        periodSeconds</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">15</span></span>
<span class="line"><span style="color:#85E89D">      selectPolicy</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">Max</span></span>
<span class="line"><span style="color:#B392F0">---</span></span>
<span class="line"><span style="color:#6A737D"># Vertical Pod Autoscaler for order service (stateful)</span></span>
<span class="line"><span style="color:#85E89D">apiVersion</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">autoscaling.k8s.io/v1</span></span>
<span class="line"><span style="color:#85E89D">kind</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">VerticalPodAutoscaler</span></span>
<span class="line"><span style="color:#85E89D">metadata</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#85E89D">  name</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">order-service-vpa</span></span>
<span class="line"><span style="color:#85E89D">  namespace</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">ecommerce</span></span>
<span class="line"><span style="color:#85E89D">spec</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#85E89D">  targetRef</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#85E89D">    apiVersion</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">apps/v1</span></span>
<span class="line"><span style="color:#85E89D">    kind</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">Deployment</span></span>
<span class="line"><span style="color:#85E89D">    name</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">order-service</span></span>
<span class="line"><span style="color:#85E89D">  updatePolicy</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#85E89D">    updateMode</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">"Auto"</span></span>
<span class="line"><span style="color:#85E89D">  resourcePolicy</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#85E89D">    containerPolicies</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">    - </span><span style="color:#85E89D">containerName</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">order-service</span></span>
<span class="line"><span style="color:#85E89D">      maxAllowed</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#85E89D">        cpu</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">2</span></span>
<span class="line"><span style="color:#85E89D">        memory</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">4Gi</span></span>
<span class="line"><span style="color:#85E89D">      minAllowed</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#85E89D">        cpu</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">100m</span></span>
<span class="line"><span style="color:#85E89D">        memory</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">256Mi</span></span>
<span class="line"><span style="color:#85E89D">      controlledResources</span><span style="color:#E1E4E8">: [</span><span style="color:#9ECBFF">"cpu"</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">"memory"</span><span style="color:#E1E4E8">]</span></span>
<span class="line"></span></code></pre>
<h3 id="2-database-scaling-solutions">2. Database Scaling Solutions</h3>
<p>Implement read replicas and sharding for database scalability.</p>
<p><strong>Database Scaling Architecture</strong></p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="typescript"><code><span class="line"><span style="color:#F97583">interface</span><span style="color:#B392F0"> DatabaseConfig</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#FFAB70">  primary</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#FFAB70">    host</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#FFAB70">    port</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> number</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#FFAB70">    database</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#FFAB70">    maxConnections</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> number</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">  };</span></span>
<span class="line"><span style="color:#FFAB70">  readReplicas</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Array</span><span style="color:#E1E4E8">&#x3C;{</span></span>
<span class="line"><span style="color:#FFAB70">    host</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#FFAB70">    port</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> number</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#FFAB70">    database</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#FFAB70">    weight</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> number</span><span style="color:#E1E4E8">; </span><span style="color:#6A737D">// for load balancing</span></span>
<span class="line"><span style="color:#E1E4E8">  }>;</span></span>
<span class="line"><span style="color:#FFAB70">  sharding</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#FFAB70">    enabled</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> boolean</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#FFAB70">    shardKey</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#FFAB70">    shards</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Array</span><span style="color:#E1E4E8">&#x3C;{</span></span>
<span class="line"><span style="color:#FFAB70">      id</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#FFAB70">      range</span><span style="color:#F97583">:</span><span style="color:#E1E4E8"> { </span><span style="color:#FFAB70">start</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">; </span><span style="color:#FFAB70">end</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8"> };</span></span>
<span class="line"><span style="color:#FFAB70">      connection</span><span style="color:#F97583">:</span><span style="color:#B392F0"> DatabaseConnection</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">    }>;</span></span>
<span class="line"><span style="color:#E1E4E8">  };</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">class</span><span style="color:#B392F0"> ScalableDatabaseManager</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">  private</span><span style="color:#FFAB70"> primaryConnection</span><span style="color:#F97583">:</span><span style="color:#B392F0"> DatabaseConnection</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">  private</span><span style="color:#FFAB70"> readReplicas</span><span style="color:#F97583">:</span><span style="color:#B392F0"> DatabaseConnection</span><span style="color:#E1E4E8">[];</span></span>
<span class="line"><span style="color:#F97583">  private</span><span style="color:#FFAB70"> shardConnections</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Map</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#79B8FF">string</span><span style="color:#E1E4E8">, </span><span style="color:#B392F0">DatabaseConnection</span><span style="color:#E1E4E8">>;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">  constructor</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">private</span><span style="color:#FFAB70"> config</span><span style="color:#F97583">:</span><span style="color:#B392F0"> DatabaseConfig</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#79B8FF">    this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">initializeConnections</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">  async</span><span style="color:#B392F0"> query</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">sql</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">params</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> any</span><span style="color:#E1E4E8">[], </span><span style="color:#FFAB70">options</span><span style="color:#F97583">:</span><span style="color:#B392F0"> QueryOptions</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> {})</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Promise</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#79B8FF">any</span><span style="color:#E1E4E8">> {</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#E1E4E8"> { </span><span style="color:#79B8FF">readOnly</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> false</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">shardKey</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">consistencyLevel</span><span style="color:#F97583"> =</span><span style="color:#9ECBFF"> 'eventual'</span><span style="color:#E1E4E8"> } </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> options;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (readOnly </span><span style="color:#F97583">&#x26;&#x26;</span><span style="color:#E1E4E8"> consistencyLevel </span><span style="color:#F97583">===</span><span style="color:#9ECBFF"> 'eventual'</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#6A737D">      // Use read replica for read-only queries</span></span>
<span class="line"><span style="color:#F97583">      const</span><span style="color:#79B8FF"> replica</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">selectReadReplica</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">      return</span><span style="color:#F97583"> await</span><span style="color:#E1E4E8"> replica.</span><span style="color:#B392F0">query</span><span style="color:#E1E4E8">(sql, params);</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (</span><span style="color:#79B8FF">this</span><span style="color:#E1E4E8">.config.sharding.enabled </span><span style="color:#F97583">&#x26;&#x26;</span><span style="color:#E1E4E8"> shardKey) {</span></span>
<span class="line"><span style="color:#6A737D">      // Route to appropriate shard</span></span>
<span class="line"><span style="color:#F97583">      const</span><span style="color:#79B8FF"> shard</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">selectShard</span><span style="color:#E1E4E8">(shardKey);</span></span>
<span class="line"><span style="color:#F97583">      return</span><span style="color:#F97583"> await</span><span style="color:#E1E4E8"> shard.</span><span style="color:#B392F0">query</span><span style="color:#E1E4E8">(sql, params);</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // Use primary connection for writes and consistent reads</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#F97583"> await</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.primaryConnection.</span><span style="color:#B392F0">query</span><span style="color:#E1E4E8">(sql, params);</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">  private</span><span style="color:#B392F0"> selectReadReplica</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">:</span><span style="color:#B392F0"> DatabaseConnection</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">    // Weighted round-robin selection</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> totalWeight</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.readReplicas.</span><span style="color:#B392F0">reduce</span><span style="color:#E1E4E8">((</span><span style="color:#FFAB70">sum</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">replica</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> sum </span><span style="color:#F97583">+</span><span style="color:#E1E4E8"> replica.weight, </span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">    let</span><span style="color:#E1E4E8"> random </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> Math.</span><span style="color:#B392F0">random</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">*</span><span style="color:#E1E4E8"> totalWeight;</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#F97583">    for</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">const</span><span style="color:#79B8FF"> replica</span><span style="color:#F97583"> of</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.readReplicas) {</span></span>
<span class="line"><span style="color:#E1E4E8">      random </span><span style="color:#F97583">-=</span><span style="color:#E1E4E8"> replica.weight;</span></span>
<span class="line"><span style="color:#F97583">      if</span><span style="color:#E1E4E8"> (random </span><span style="color:#F97583">&#x3C;=</span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">) {</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#E1E4E8"> replica;</span></span>
<span class="line"><span style="color:#E1E4E8">      }</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.readReplicas[</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">]; </span><span style="color:#6A737D">// fallback</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">  private</span><span style="color:#B392F0"> selectShard</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">shardKey</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">:</span><span style="color:#B392F0"> DatabaseConnection</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> shardId</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">calculateShardId</span><span style="color:#E1E4E8">(shardKey);</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> connection</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.shardConnections.</span><span style="color:#B392F0">get</span><span style="color:#E1E4E8">(shardId);</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">!</span><span style="color:#E1E4E8">connection) {</span></span>
<span class="line"><span style="color:#F97583">      throw</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> Error</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">`No connection found for shard: ${</span><span style="color:#E1E4E8">shardId</span><span style="color:#9ECBFF">}`</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> connection;</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">  private</span><span style="color:#B392F0"> calculateShardId</span><span style="color:#E1E4E8">(</span><span style="color:#FFAB70">shardKey</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8">)</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> string</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">    // Use consistent hashing for shard selection</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> hash</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">hashFunction</span><span style="color:#E1E4E8">(shardKey);</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#F97583">    for</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">const</span><span style="color:#79B8FF"> shard</span><span style="color:#F97583"> of</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.config.sharding.shards) {</span></span>
<span class="line"><span style="color:#F97583">      if</span><span style="color:#E1E4E8"> (hash </span><span style="color:#F97583">>=</span><span style="color:#E1E4E8"> shard.range.start </span><span style="color:#F97583">&#x26;&#x26;</span><span style="color:#E1E4E8"> hash </span><span style="color:#F97583">&#x3C;=</span><span style="color:#E1E4E8"> shard.range.end) {</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#E1E4E8"> shard.id;</span></span>
<span class="line"><span style="color:#E1E4E8">      }</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#F97583">    throw</span><span style="color:#F97583"> new</span><span style="color:#B392F0"> Error</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">`No shard found for key: ${</span><span style="color:#E1E4E8">shardKey</span><span style="color:#9ECBFF">}`</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">  // Connection health monitoring</span></span>
<span class="line"><span style="color:#F97583">  async</span><span style="color:#B392F0"> healthCheck</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Promise</span><span style="color:#E1E4E8">&#x3C;</span><span style="color:#B392F0">DatabaseHealth</span><span style="color:#E1E4E8">> {</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> health</span><span style="color:#F97583">:</span><span style="color:#B392F0"> DatabaseHealth</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">      primary: { healthy: </span><span style="color:#79B8FF">false</span><span style="color:#E1E4E8">, latency: </span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8"> },</span></span>
<span class="line"><span style="color:#E1E4E8">      readReplicas: [],</span></span>
<span class="line"><span style="color:#E1E4E8">      shards: []</span></span>
<span class="line"><span style="color:#E1E4E8">    };</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // Check primary connection</span></span>
<span class="line"><span style="color:#F97583">    try</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">      const</span><span style="color:#79B8FF"> start</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> Date.</span><span style="color:#B392F0">now</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">      await</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.primaryConnection.</span><span style="color:#B392F0">query</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'SELECT 1'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">      health.primary </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">        healthy: </span><span style="color:#79B8FF">true</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">        latency: Date.</span><span style="color:#B392F0">now</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">-</span><span style="color:#E1E4E8"> start</span></span>
<span class="line"><span style="color:#E1E4E8">      };</span></span>
<span class="line"><span style="color:#E1E4E8">    } </span><span style="color:#F97583">catch</span><span style="color:#E1E4E8"> (error) {</span></span>
<span class="line"><span style="color:#E1E4E8">      console.</span><span style="color:#B392F0">error</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'Primary database health check failed:'</span><span style="color:#E1E4E8">, error);</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // Check read replicas</span></span>
<span class="line"><span style="color:#F97583">    for</span><span style="color:#E1E4E8"> (</span><span style="color:#F97583">const</span><span style="color:#79B8FF"> replica</span><span style="color:#F97583"> of</span><span style="color:#79B8FF"> this</span><span style="color:#E1E4E8">.readReplicas) {</span></span>
<span class="line"><span style="color:#F97583">      try</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">        const</span><span style="color:#79B8FF"> start</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> Date.</span><span style="color:#B392F0">now</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#F97583">        await</span><span style="color:#E1E4E8"> replica.</span><span style="color:#B392F0">query</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'SELECT 1'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">        health.readReplicas.</span><span style="color:#B392F0">push</span><span style="color:#E1E4E8">({</span></span>
<span class="line"><span style="color:#E1E4E8">          host: replica.host,</span></span>
<span class="line"><span style="color:#E1E4E8">          healthy: </span><span style="color:#79B8FF">true</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">          latency: Date.</span><span style="color:#B392F0">now</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">-</span><span style="color:#E1E4E8"> start</span></span>
<span class="line"><span style="color:#E1E4E8">        });</span></span>
<span class="line"><span style="color:#E1E4E8">      } </span><span style="color:#F97583">catch</span><span style="color:#E1E4E8"> (error) {</span></span>
<span class="line"><span style="color:#E1E4E8">        health.readReplicas.</span><span style="color:#B392F0">push</span><span style="color:#E1E4E8">({</span></span>
<span class="line"><span style="color:#E1E4E8">          host: replica.host,</span></span>
<span class="line"><span style="color:#E1E4E8">          healthy: </span><span style="color:#79B8FF">false</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">          latency: </span><span style="color:#79B8FF">0</span></span>
<span class="line"><span style="color:#E1E4E8">        });</span></span>
<span class="line"><span style="color:#E1E4E8">      }</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> health;</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre>
<h2 id="testing-and-quality-assurance">Testing and Quality Assurance</h2>
<h3 id="1-comprehensive-testing-strategy">1. Comprehensive Testing Strategy</h3>
<p>Implement testing at all levels of the e-commerce platform.</p>
<p><strong>E2E Testing Framework</strong></p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="typescript"><code><span class="line"><span style="color:#6A737D">// tests/e2e/checkout-flow.test.ts</span></span>
<span class="line"><span style="color:#B392F0">describe</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'E-commerce Checkout Flow'</span><span style="color:#E1E4E8">, () </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">  let</span><span style="color:#E1E4E8"> page</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Page</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">  let</span><span style="color:#E1E4E8"> browser</span><span style="color:#F97583">:</span><span style="color:#B392F0"> Browser</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">  beforeAll</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">async</span><span style="color:#E1E4E8"> () </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">    browser </span><span style="color:#F97583">=</span><span style="color:#F97583"> await</span><span style="color:#E1E4E8"> chromium.</span><span style="color:#B392F0">launch</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">    page </span><span style="color:#F97583">=</span><span style="color:#F97583"> await</span><span style="color:#E1E4E8"> browser.</span><span style="color:#B392F0">newPage</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">  });</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">  afterAll</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">async</span><span style="color:#E1E4E8"> () </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">    await</span><span style="color:#E1E4E8"> browser.</span><span style="color:#B392F0">close</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">  });</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">  it</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'should complete full checkout process'</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">async</span><span style="color:#E1E4E8"> () </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">    // 1. Browse products</span></span>
<span class="line"><span style="color:#F97583">    await</span><span style="color:#E1E4E8"> page.</span><span style="color:#B392F0">goto</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'/products'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">    await</span><span style="color:#E1E4E8"> page.</span><span style="color:#B392F0">waitForSelector</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'[data-testid="product-grid"]'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#6A737D">    // Select a product</span></span>
<span class="line"><span style="color:#F97583">    await</span><span style="color:#E1E4E8"> page.</span><span style="color:#B392F0">click</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'[data-testid="product-card"]:first-child'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">    await</span><span style="color:#E1E4E8"> page.</span><span style="color:#B392F0">waitForSelector</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'[data-testid="product-details"]'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#6A737D">    // 2. Add to cart</span></span>
<span class="line"><span style="color:#F97583">    await</span><span style="color:#E1E4E8"> page.</span><span style="color:#B392F0">click</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'[data-testid="add-to-cart-btn"]'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">    await</span><span style="color:#E1E4E8"> page.</span><span style="color:#B392F0">waitForSelector</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'[data-testid="cart-notification"]'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#6A737D">    // Verify cart count updated</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> cartCount</span><span style="color:#F97583"> =</span><span style="color:#F97583"> await</span><span style="color:#E1E4E8"> page.</span><span style="color:#B392F0">textContent</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'[data-testid="cart-count"]'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#B392F0">    expect</span><span style="color:#E1E4E8">(cartCount).</span><span style="color:#B392F0">toBe</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'1'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#6A737D">    // 3. Go to cart</span></span>
<span class="line"><span style="color:#F97583">    await</span><span style="color:#E1E4E8"> page.</span><span style="color:#B392F0">click</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'[data-testid="cart-icon"]'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">    await</span><span style="color:#E1E4E8"> page.</span><span style="color:#B392F0">waitForSelector</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'[data-testid="cart-page"]'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#6A737D">    // Verify product in cart</span></span>
<span class="line"><span style="color:#F97583">    await</span><span style="color:#B392F0"> expect</span><span style="color:#E1E4E8">(page.</span><span style="color:#B392F0">locator</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'[data-testid="cart-item"]'</span><span style="color:#E1E4E8">)).</span><span style="color:#B392F0">toHaveCount</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#6A737D">    // 4. Proceed to checkout</span></span>
<span class="line"><span style="color:#F97583">    await</span><span style="color:#E1E4E8"> page.</span><span style="color:#B392F0">click</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'[data-testid="checkout-btn"]'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">    await</span><span style="color:#E1E4E8"> page.</span><span style="color:#B392F0">waitForSelector</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'[data-testid="checkout-form"]'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#6A737D">    // 5. Fill shipping information</span></span>
<span class="line"><span style="color:#F97583">    await</span><span style="color:#E1E4E8"> page.</span><span style="color:#B392F0">fill</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'[data-testid="email-input"]'</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'test@example.com'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">    await</span><span style="color:#E1E4E8"> page.</span><span style="color:#B392F0">fill</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'[data-testid="first-name-input"]'</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'John'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">    await</span><span style="color:#E1E4E8"> page.</span><span style="color:#B392F0">fill</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'[data-testid="last-name-input"]'</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'Doe'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">    await</span><span style="color:#E1E4E8"> page.</span><span style="color:#B392F0">fill</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'[data-testid="address-input"]'</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'123 Main St'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">    await</span><span style="color:#E1E4E8"> page.</span><span style="color:#B392F0">fill</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'[data-testid="city-input"]'</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'New York'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">    await</span><span style="color:#E1E4E8"> page.</span><span style="color:#B392F0">selectOption</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'[data-testid="state-select"]'</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'NY'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">    await</span><span style="color:#E1E4E8"> page.</span><span style="color:#B392F0">fill</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'[data-testid="zip-input"]'</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'10001'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#6A737D">    // Continue to payment</span></span>
<span class="line"><span style="color:#F97583">    await</span><span style="color:#E1E4E8"> page.</span><span style="color:#B392F0">click</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'[data-testid="continue-to-payment-btn"]'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">    await</span><span style="color:#E1E4E8"> page.</span><span style="color:#B392F0">waitForSelector</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'[data-testid="payment-form"]'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#6A737D">    // 6. Fill payment information (test card)</span></span>
<span class="line"><span style="color:#F97583">    await</span><span style="color:#E1E4E8"> page.</span><span style="color:#B392F0">fill</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'[data-testid="card-number-input"]'</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'4242424242424242'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">    await</span><span style="color:#E1E4E8"> page.</span><span style="color:#B392F0">fill</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'[data-testid="card-expiry-input"]'</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'12/25'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">    await</span><span style="color:#E1E4E8"> page.</span><span style="color:#B392F0">fill</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'[data-testid="card-cvc-input"]'</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'123'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">    await</span><span style="color:#E1E4E8"> page.</span><span style="color:#B392F0">fill</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'[data-testid="card-name-input"]'</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'John Doe'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#6A737D">    // 7. Place order</span></span>
<span class="line"><span style="color:#F97583">    await</span><span style="color:#E1E4E8"> page.</span><span style="color:#B392F0">click</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'[data-testid="place-order-btn"]'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#6A737D">    // 8. Verify order confirmation</span></span>
<span class="line"><span style="color:#F97583">    await</span><span style="color:#E1E4E8"> page.</span><span style="color:#B392F0">waitForSelector</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'[data-testid="order-confirmation"]'</span><span style="color:#E1E4E8">, { timeout: </span><span style="color:#79B8FF">30000</span><span style="color:#E1E4E8"> });</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> orderNumber</span><span style="color:#F97583"> =</span><span style="color:#F97583"> await</span><span style="color:#E1E4E8"> page.</span><span style="color:#B392F0">textContent</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'[data-testid="order-number"]'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#B392F0">    expect</span><span style="color:#E1E4E8">(orderNumber).</span><span style="color:#B392F0">toMatch</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">/</span><span style="color:#F97583">^</span><span style="color:#DBEDFF">ORD-</span><span style="color:#79B8FF">\d</span><span style="color:#F97583">+$</span><span style="color:#9ECBFF">/</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#6A737D">    // Verify order details</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> orderTotal</span><span style="color:#F97583"> =</span><span style="color:#F97583"> await</span><span style="color:#E1E4E8"> page.</span><span style="color:#B392F0">textContent</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'[data-testid="order-total"]'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#B392F0">    expect</span><span style="color:#E1E4E8">(orderTotal).</span><span style="color:#B392F0">toBeTruthy</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#6A737D">    // 9. Check order in account</span></span>
<span class="line"><span style="color:#F97583">    await</span><span style="color:#E1E4E8"> page.</span><span style="color:#B392F0">click</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'[data-testid="view-order-btn"]'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">    await</span><span style="color:#E1E4E8"> page.</span><span style="color:#B392F0">waitForSelector</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'[data-testid="order-details"]'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> orderStatus</span><span style="color:#F97583"> =</span><span style="color:#F97583"> await</span><span style="color:#E1E4E8"> page.</span><span style="color:#B392F0">textContent</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'[data-testid="order-status"]'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#B392F0">    expect</span><span style="color:#E1E4E8">(orderStatus).</span><span style="color:#B392F0">toBe</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'Payment Confirmed'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">  });</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">  it</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'should handle cart abandonment recovery'</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">async</span><span style="color:#E1E4E8"> () </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">    // Add product to cart</span></span>
<span class="line"><span style="color:#F97583">    await</span><span style="color:#E1E4E8"> page.</span><span style="color:#B392F0">goto</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'/products'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">    await</span><span style="color:#E1E4E8"> page.</span><span style="color:#B392F0">click</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'[data-testid="product-card"]:first-child'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">    await</span><span style="color:#E1E4E8"> page.</span><span style="color:#B392F0">click</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'[data-testid="add-to-cart-btn"]'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#6A737D">    // Go to checkout but don't complete</span></span>
<span class="line"><span style="color:#F97583">    await</span><span style="color:#E1E4E8"> page.</span><span style="color:#B392F0">click</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'[data-testid="cart-icon"]'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">    await</span><span style="color:#E1E4E8"> page.</span><span style="color:#B392F0">click</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'[data-testid="checkout-btn"]'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">    await</span><span style="color:#E1E4E8"> page.</span><span style="color:#B392F0">fill</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'[data-testid="email-input"]'</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'abandoned@example.com'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#6A737D">    // Simulate leaving the page</span></span>
<span class="line"><span style="color:#F97583">    await</span><span style="color:#E1E4E8"> page.</span><span style="color:#B392F0">goto</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'/'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#6A737D">    // Verify cart abandonment event was tracked</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> abandonmentEvents</span><span style="color:#F97583"> =</span><span style="color:#F97583"> await</span><span style="color:#E1E4E8"> page.</span><span style="color:#B392F0">evaluate</span><span style="color:#E1E4E8">(() </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">      return</span><span style="color:#E1E4E8"> window.analytics?.track?.</span><span style="color:#B392F0">getCalls</span><span style="color:#E1E4E8">?.() </span><span style="color:#F97583">||</span><span style="color:#E1E4E8"> [];</span></span>
<span class="line"><span style="color:#E1E4E8">    });</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> cartAbandonmentEvent</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> abandonmentEvents.</span><span style="color:#B392F0">find</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#FFAB70">      call</span><span style="color:#F97583"> =></span><span style="color:#E1E4E8"> call.args[</span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">===</span><span style="color:#9ECBFF"> 'Cart Abandoned'</span></span>
<span class="line"><span style="color:#E1E4E8">    );</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#B392F0">    expect</span><span style="color:#E1E4E8">(cartAbandonmentEvent).</span><span style="color:#B392F0">toBeTruthy</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">  });</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0">  it</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'should handle inventory updates during checkout'</span><span style="color:#E1E4E8">, </span><span style="color:#F97583">async</span><span style="color:#E1E4E8"> () </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#6A737D">    // Start checkout process</span></span>
<span class="line"><span style="color:#F97583">    await</span><span style="color:#E1E4E8"> page.</span><span style="color:#B392F0">goto</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'/products'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">    await</span><span style="color:#E1E4E8"> page.</span><span style="color:#B392F0">click</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'[data-testid="product-card"]:first-child'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#6A737D">    // Get product ID for inventory manipulation</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> productId</span><span style="color:#F97583"> =</span><span style="color:#F97583"> await</span><span style="color:#E1E4E8"> page.</span><span style="color:#B392F0">getAttribute</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'[data-testid="product-details"]'</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'data-product-id'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#F97583">    await</span><span style="color:#E1E4E8"> page.</span><span style="color:#B392F0">click</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'[data-testid="add-to-cart-btn"]'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">    await</span><span style="color:#E1E4E8"> page.</span><span style="color:#B392F0">click</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'[data-testid="cart-icon"]'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">    await</span><span style="color:#E1E4E8"> page.</span><span style="color:#B392F0">click</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'[data-testid="checkout-btn"]'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#6A737D">    // Simulate inventory change via API</span></span>
<span class="line"><span style="color:#F97583">    await</span><span style="color:#E1E4E8"> page.</span><span style="color:#B392F0">evaluate</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">async</span><span style="color:#E1E4E8"> (</span><span style="color:#FFAB70">id</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">      await</span><span style="color:#B392F0"> fetch</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">`/api/products/${</span><span style="color:#E1E4E8">id</span><span style="color:#9ECBFF">}/inventory`</span><span style="color:#E1E4E8">, {</span></span>
<span class="line"><span style="color:#E1E4E8">        method: </span><span style="color:#9ECBFF">'PUT'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#E1E4E8">        headers: { </span><span style="color:#9ECBFF">'Content-Type'</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">'application/json'</span><span style="color:#E1E4E8"> },</span></span>
<span class="line"><span style="color:#E1E4E8">        body: </span><span style="color:#79B8FF">JSON</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">stringify</span><span style="color:#E1E4E8">({ quantity: </span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8"> })</span></span>
<span class="line"><span style="color:#E1E4E8">      });</span></span>
<span class="line"><span style="color:#E1E4E8">    }, productId);</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#6A737D">    // Try to complete checkout</span></span>
<span class="line"><span style="color:#F97583">    await</span><span style="color:#E1E4E8"> page.</span><span style="color:#B392F0">fill</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'[data-testid="email-input"]'</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">'test@example.com'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#6A737D">    // ... fill other fields</span></span>
<span class="line"><span style="color:#F97583">    await</span><span style="color:#E1E4E8"> page.</span><span style="color:#B392F0">click</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'[data-testid="place-order-btn"]'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#6A737D">    // Should show inventory error</span></span>
<span class="line"><span style="color:#F97583">    await</span><span style="color:#E1E4E8"> page.</span><span style="color:#B392F0">waitForSelector</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'[data-testid="inventory-error"]'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#F97583">    const</span><span style="color:#79B8FF"> errorMessage</span><span style="color:#F97583"> =</span><span style="color:#F97583"> await</span><span style="color:#E1E4E8"> page.</span><span style="color:#B392F0">textContent</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'[data-testid="inventory-error"]'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#B392F0">    expect</span><span style="color:#E1E4E8">(errorMessage).</span><span style="color:#B392F0">toContain</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'no longer available'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">  });</span></span>
<span class="line"><span style="color:#E1E4E8">});</span></span>
<span class="line"></span></code></pre>
<h3 id="2-performance-testing">2. Performance Testing</h3>
<p>Implement load testing to validate platform performance under stress.</p>
<p><strong>Load Testing Configuration</strong></p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="typescript"><code><span class="line"><span style="color:#6A737D">// tests/performance/load-test.ts</span></span>
<span class="line"><span style="color:#F97583">import</span><span style="color:#E1E4E8"> { check, sleep } </span><span style="color:#F97583">from</span><span style="color:#9ECBFF"> 'k6'</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#F97583">import</span><span style="color:#E1E4E8"> http </span><span style="color:#F97583">from</span><span style="color:#9ECBFF"> 'k6/http'</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">export</span><span style="color:#F97583"> let</span><span style="color:#E1E4E8"> options </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">  stages: [</span></span>
<span class="line"><span style="color:#E1E4E8">    { duration: </span><span style="color:#9ECBFF">'2m'</span><span style="color:#E1E4E8">, target: </span><span style="color:#79B8FF">100</span><span style="color:#E1E4E8"> }, </span><span style="color:#6A737D">// Ramp up to 100 users</span></span>
<span class="line"><span style="color:#E1E4E8">    { duration: </span><span style="color:#9ECBFF">'5m'</span><span style="color:#E1E4E8">, target: </span><span style="color:#79B8FF">100</span><span style="color:#E1E4E8"> }, </span><span style="color:#6A737D">// Sustained load</span></span>
<span class="line"><span style="color:#E1E4E8">    { duration: </span><span style="color:#9ECBFF">'2m'</span><span style="color:#E1E4E8">, target: </span><span style="color:#79B8FF">200</span><span style="color:#E1E4E8"> }, </span><span style="color:#6A737D">// Ramp up to 200 users</span></span>
<span class="line"><span style="color:#E1E4E8">    { duration: </span><span style="color:#9ECBFF">'5m'</span><span style="color:#E1E4E8">, target: </span><span style="color:#79B8FF">200</span><span style="color:#E1E4E8"> }, </span><span style="color:#6A737D">// Sustained load</span></span>
<span class="line"><span style="color:#E1E4E8">    { duration: </span><span style="color:#9ECBFF">'2m'</span><span style="color:#E1E4E8">, target: </span><span style="color:#79B8FF">500</span><span style="color:#E1E4E8"> }, </span><span style="color:#6A737D">// Spike test</span></span>
<span class="line"><span style="color:#E1E4E8">    { duration: </span><span style="color:#9ECBFF">'3m'</span><span style="color:#E1E4E8">, target: </span><span style="color:#79B8FF">500</span><span style="color:#E1E4E8"> }, </span><span style="color:#6A737D">// Sustained spike</span></span>
<span class="line"><span style="color:#E1E4E8">    { duration: </span><span style="color:#9ECBFF">'2m'</span><span style="color:#E1E4E8">, target: </span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8"> }    </span><span style="color:#6A737D">// Ramp down</span></span>
<span class="line"><span style="color:#E1E4E8">  ],</span></span>
<span class="line"><span style="color:#E1E4E8">  thresholds: {</span></span>
<span class="line"><span style="color:#E1E4E8">    http_req_duration: [</span><span style="color:#9ECBFF">'p(95)&#x3C;500'</span><span style="color:#E1E4E8">], </span><span style="color:#6A737D">// 95% of requests under 500ms</span></span>
<span class="line"><span style="color:#E1E4E8">    http_req_failed: [</span><span style="color:#9ECBFF">'rate&#x3C;0.01'</span><span style="color:#E1E4E8">],   </span><span style="color:#6A737D">// Error rate under 1%</span></span>
<span class="line"><span style="color:#E1E4E8">    checks: [</span><span style="color:#9ECBFF">'rate>0.95'</span><span style="color:#E1E4E8">]             </span><span style="color:#6A737D">// 95% of checks pass</span></span>
<span class="line"><span style="color:#E1E4E8">  }</span></span>
<span class="line"><span style="color:#E1E4E8">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">export</span><span style="color:#F97583"> default</span><span style="color:#F97583"> function</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#6A737D">  // Simulate user shopping journey</span></span>
<span class="line"><span style="color:#E1E4E8">  </span></span>
<span class="line"><span style="color:#6A737D">  // 1. Browse homepage</span></span>
<span class="line"><span style="color:#F97583">  let</span><span style="color:#E1E4E8"> response </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> http.</span><span style="color:#B392F0">get</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'https://api.example.com/'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#B392F0">  check</span><span style="color:#E1E4E8">(response, {</span></span>
<span class="line"><span style="color:#9ECBFF">    'homepage loads'</span><span style="color:#E1E4E8">: (</span><span style="color:#FFAB70">r</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> r.status </span><span style="color:#F97583">===</span><span style="color:#79B8FF"> 200</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">    'homepage response time'</span><span style="color:#E1E4E8">: (</span><span style="color:#FFAB70">r</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> r.timings.duration </span><span style="color:#F97583">&#x3C;</span><span style="color:#79B8FF"> 1000</span></span>
<span class="line"><span style="color:#E1E4E8">  });</span></span>
<span class="line"><span style="color:#E1E4E8">  </span></span>
<span class="line"><span style="color:#B392F0">  sleep</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">  </span></span>
<span class="line"><span style="color:#6A737D">  // 2. Search for products</span></span>
<span class="line"><span style="color:#E1E4E8">  response </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> http.</span><span style="color:#B392F0">get</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'https://api.example.com/api/products/search?q=laptop&#x26;page=1&#x26;limit=20'</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#B392F0">  check</span><span style="color:#E1E4E8">(response, {</span></span>
<span class="line"><span style="color:#9ECBFF">    'search works'</span><span style="color:#E1E4E8">: (</span><span style="color:#FFAB70">r</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> r.status </span><span style="color:#F97583">===</span><span style="color:#79B8FF"> 200</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">    'search has results'</span><span style="color:#E1E4E8">: (</span><span style="color:#FFAB70">r</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">=></span><span style="color:#79B8FF"> JSON</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">parse</span><span style="color:#E1E4E8">(r.body).products.</span><span style="color:#79B8FF">length</span><span style="color:#F97583"> ></span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">    'search response time'</span><span style="color:#E1E4E8">: (</span><span style="color:#FFAB70">r</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> r.timings.duration </span><span style="color:#F97583">&#x3C;</span><span style="color:#79B8FF"> 500</span></span>
<span class="line"><span style="color:#E1E4E8">  });</span></span>
<span class="line"><span style="color:#E1E4E8">  </span></span>
<span class="line"><span style="color:#F97583">  const</span><span style="color:#79B8FF"> products</span><span style="color:#F97583"> =</span><span style="color:#79B8FF"> JSON</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">parse</span><span style="color:#E1E4E8">(response.body).products;</span></span>
<span class="line"><span style="color:#F97583">  const</span><span style="color:#79B8FF"> randomProduct</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> products[Math.</span><span style="color:#B392F0">floor</span><span style="color:#E1E4E8">(Math.</span><span style="color:#B392F0">random</span><span style="color:#E1E4E8">() </span><span style="color:#F97583">*</span><span style="color:#E1E4E8"> products.</span><span style="color:#79B8FF">length</span><span style="color:#E1E4E8">)];</span></span>
<span class="line"><span style="color:#E1E4E8">  </span></span>
<span class="line"><span style="color:#B392F0">  sleep</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">2</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">  </span></span>
<span class="line"><span style="color:#6A737D">  // 3. View product details</span></span>
<span class="line"><span style="color:#E1E4E8">  response </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> http.</span><span style="color:#B392F0">get</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">`https://api.example.com/api/products/${</span><span style="color:#E1E4E8">randomProduct</span><span style="color:#9ECBFF">.</span><span style="color:#E1E4E8">id</span><span style="color:#9ECBFF">}`</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#B392F0">  check</span><span style="color:#E1E4E8">(response, {</span></span>
<span class="line"><span style="color:#9ECBFF">    'product details load'</span><span style="color:#E1E4E8">: (</span><span style="color:#FFAB70">r</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> r.status </span><span style="color:#F97583">===</span><span style="color:#79B8FF"> 200</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">    'product details response time'</span><span style="color:#E1E4E8">: (</span><span style="color:#FFAB70">r</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> r.timings.duration </span><span style="color:#F97583">&#x3C;</span><span style="color:#79B8FF"> 300</span></span>
<span class="line"><span style="color:#E1E4E8">  });</span></span>
<span class="line"><span style="color:#E1E4E8">  </span></span>
<span class="line"><span style="color:#B392F0">  sleep</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">3</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">  </span></span>
<span class="line"><span style="color:#6A737D">  // 4. Add to cart</span></span>
<span class="line"><span style="color:#F97583">  const</span><span style="color:#79B8FF"> cartPayload</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">    productId: randomProduct.id,</span></span>
<span class="line"><span style="color:#E1E4E8">    quantity: </span><span style="color:#79B8FF">1</span></span>
<span class="line"><span style="color:#E1E4E8">  };</span></span>
<span class="line"><span style="color:#E1E4E8">  </span></span>
<span class="line"><span style="color:#E1E4E8">  response </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> http.</span><span style="color:#B392F0">post</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#9ECBFF">    'https://api.example.com/api/cart/items'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#79B8FF">    JSON</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">stringify</span><span style="color:#E1E4E8">(cartPayload),</span></span>
<span class="line"><span style="color:#E1E4E8">    {</span></span>
<span class="line"><span style="color:#E1E4E8">      headers: {</span></span>
<span class="line"><span style="color:#9ECBFF">        'Content-Type'</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">'application/json'</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">        'Authorization'</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">`Bearer ${</span><span style="color:#B392F0">getAuthToken</span><span style="color:#9ECBFF">()</span><span style="color:#9ECBFF">}`</span></span>
<span class="line"><span style="color:#E1E4E8">      }</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">  );</span></span>
<span class="line"><span style="color:#E1E4E8">  </span></span>
<span class="line"><span style="color:#B392F0">  check</span><span style="color:#E1E4E8">(response, {</span></span>
<span class="line"><span style="color:#9ECBFF">    'add to cart works'</span><span style="color:#E1E4E8">: (</span><span style="color:#FFAB70">r</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> r.status </span><span style="color:#F97583">===</span><span style="color:#79B8FF"> 200</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">    'add to cart response time'</span><span style="color:#E1E4E8">: (</span><span style="color:#FFAB70">r</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> r.timings.duration </span><span style="color:#F97583">&#x3C;</span><span style="color:#79B8FF"> 200</span></span>
<span class="line"><span style="color:#E1E4E8">  });</span></span>
<span class="line"><span style="color:#E1E4E8">  </span></span>
<span class="line"><span style="color:#B392F0">  sleep</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">  </span></span>
<span class="line"><span style="color:#6A737D">  // 5. View cart</span></span>
<span class="line"><span style="color:#E1E4E8">  response </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> http.</span><span style="color:#B392F0">get</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'https://api.example.com/api/cart'</span><span style="color:#E1E4E8">, {</span></span>
<span class="line"><span style="color:#E1E4E8">    headers: { </span><span style="color:#9ECBFF">'Authorization'</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">`Bearer ${</span><span style="color:#B392F0">getAuthToken</span><span style="color:#9ECBFF">()</span><span style="color:#9ECBFF">}`</span><span style="color:#E1E4E8"> }</span></span>
<span class="line"><span style="color:#E1E4E8">  });</span></span>
<span class="line"><span style="color:#E1E4E8">  </span></span>
<span class="line"><span style="color:#B392F0">  check</span><span style="color:#E1E4E8">(response, {</span></span>
<span class="line"><span style="color:#9ECBFF">    'cart loads'</span><span style="color:#E1E4E8">: (</span><span style="color:#FFAB70">r</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> r.status </span><span style="color:#F97583">===</span><span style="color:#79B8FF"> 200</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">    'cart has items'</span><span style="color:#E1E4E8">: (</span><span style="color:#FFAB70">r</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">=></span><span style="color:#79B8FF"> JSON</span><span style="color:#E1E4E8">.</span><span style="color:#B392F0">parse</span><span style="color:#E1E4E8">(r.body).items.</span><span style="color:#79B8FF">length</span><span style="color:#F97583"> ></span><span style="color:#79B8FF"> 0</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">    'cart response time'</span><span style="color:#E1E4E8">: (</span><span style="color:#FFAB70">r</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">=></span><span style="color:#E1E4E8"> r.timings.duration </span><span style="color:#F97583">&#x3C;</span><span style="color:#79B8FF"> 200</span></span>
<span class="line"><span style="color:#E1E4E8">  });</span></span>
<span class="line"><span style="color:#E1E4E8">  </span></span>
<span class="line"><span style="color:#B392F0">  sleep</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">5</span><span style="color:#E1E4E8">); </span><span style="color:#6A737D">// Simulate thinking time</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">function</span><span style="color:#B392F0"> getAuthToken</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#6A737D">  // In real test, this would handle authentication</span></span>
<span class="line"><span style="color:#F97583">  return</span><span style="color:#9ECBFF"> 'test-token-'</span><span style="color:#F97583"> +</span><span style="color:#E1E4E8"> Math.</span><span style="color:#B392F0">random</span><span style="color:#E1E4E8">().</span><span style="color:#B392F0">toString</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">36</span><span style="color:#E1E4E8">).</span><span style="color:#B392F0">substr</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">2</span><span style="color:#E1E4E8">, </span><span style="color:#79B8FF">9</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// Spike test scenario</span></span>
<span class="line"><span style="color:#F97583">export</span><span style="color:#F97583"> function</span><span style="color:#B392F0"> spikeTest</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#E1E4E8">  options.stages </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> [</span></span>
<span class="line"><span style="color:#E1E4E8">    { duration: </span><span style="color:#9ECBFF">'1m'</span><span style="color:#E1E4E8">, target: </span><span style="color:#79B8FF">100</span><span style="color:#E1E4E8"> },</span></span>
<span class="line"><span style="color:#E1E4E8">    { duration: </span><span style="color:#9ECBFF">'30s'</span><span style="color:#E1E4E8">, target: </span><span style="color:#79B8FF">1000</span><span style="color:#E1E4E8"> }, </span><span style="color:#6A737D">// Sudden spike</span></span>
<span class="line"><span style="color:#E1E4E8">    { duration: </span><span style="color:#9ECBFF">'2m'</span><span style="color:#E1E4E8">, target: </span><span style="color:#79B8FF">1000</span><span style="color:#E1E4E8"> },</span></span>
<span class="line"><span style="color:#E1E4E8">    { duration: </span><span style="color:#9ECBFF">'30s'</span><span style="color:#E1E4E8">, target: </span><span style="color:#79B8FF">100</span><span style="color:#E1E4E8"> },</span></span>
<span class="line"><span style="color:#E1E4E8">    { duration: </span><span style="color:#9ECBFF">'1m'</span><span style="color:#E1E4E8">, target: </span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8"> }</span></span>
<span class="line"><span style="color:#E1E4E8">  ];</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">// Stress test scenario  </span></span>
<span class="line"><span style="color:#F97583">export</span><span style="color:#F97583"> function</span><span style="color:#B392F0"> stressTest</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#E1E4E8">  options.stages </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> [</span></span>
<span class="line"><span style="color:#E1E4E8">    { duration: </span><span style="color:#9ECBFF">'5m'</span><span style="color:#E1E4E8">, target: </span><span style="color:#79B8FF">200</span><span style="color:#E1E4E8"> },</span></span>
<span class="line"><span style="color:#E1E4E8">    { duration: </span><span style="color:#9ECBFF">'10m'</span><span style="color:#E1E4E8">, target: </span><span style="color:#79B8FF">400</span><span style="color:#E1E4E8"> },</span></span>
<span class="line"><span style="color:#E1E4E8">    { duration: </span><span style="color:#9ECBFF">'10m'</span><span style="color:#E1E4E8">, target: </span><span style="color:#79B8FF">600</span><span style="color:#E1E4E8"> },</span></span>
<span class="line"><span style="color:#E1E4E8">    { duration: </span><span style="color:#9ECBFF">'10m'</span><span style="color:#E1E4E8">, target: </span><span style="color:#79B8FF">800</span><span style="color:#E1E4E8"> },</span></span>
<span class="line"><span style="color:#E1E4E8">    { duration: </span><span style="color:#9ECBFF">'5m'</span><span style="color:#E1E4E8">, target: </span><span style="color:#79B8FF">1000</span><span style="color:#E1E4E8"> },</span></span>
<span class="line"><span style="color:#E1E4E8">    { duration: </span><span style="color:#9ECBFF">'10m'</span><span style="color:#E1E4E8">, target: </span><span style="color:#79B8FF">0</span><span style="color:#E1E4E8"> }</span></span>
<span class="line"><span style="color:#E1E4E8">  ];</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre>
<h2 id="conclusion">Conclusion</h2>
<p>Building successful e-commerce platforms requires careful attention to architecture, performance, security, and user experience. The patterns and implementations outlined in this guide provide a foundation for creating scalable, maintainable commerce solutions that can handle enterprise-level traffic and complexity.</p>
<p>Key success factors for e-commerce platforms include:</p>
<ul>
<li><strong>Microservices Architecture</strong>: Enables independent scaling and development of different platform components</li>
<li><strong>Robust Payment Processing</strong>: Secure, compliant payment handling with multiple provider support</li>
<li><strong>Advanced Search and Discovery</strong>: Sophisticated product search with personalized recommendations</li>
<li><strong>Performance Optimization</strong>: Multi-layered caching, database optimization, and CDN integration</li>
<li><strong>Security and Compliance</strong>: PCI DSS compliance, fraud detection, and data protection</li>
<li><strong>Scalability Planning</strong>: Auto-scaling infrastructure and database sharding strategies</li>
</ul>
<p>Through my experience building e-commerce platforms across different industries and scales, Iâ€™ve learned that success comes from balancing business requirements with technical excellence, always keeping user experience at the center of architectural decisions.</p>
<p>The e-commerce landscape continues to evolve rapidly, with new technologies and customer expectations driving innovation. Platforms built with flexible, modular architectures are best positioned to adapt and grow with changing market demands.</p>
<hr>
<p><strong>Keywords</strong>: e-commerce platform architecture, microservices e-commerce, online store development, payment processing, e-commerce scalability, shopping cart implementation, product catalog architecture, e-commerce security</p> </div> </div> </div> <!-- Article Footer --> <footer class="mt-12 bg-white rounded-2xl p-8 shadow-sm border border-gray-100"> <div class="flex items-center justify-between"> <a href="/" class="inline-flex items-center text-blue-600 hover:text-blue-700 font-medium transition-colors group"> <svg class="w-4 h-4 mr-2 transition-transform group-hover:-translate-x-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"> <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path> </svg>
Back to Home
</a> <div class="flex items-center space-x-4 text-sm text-gray-500"> <span>Share this article:</span> <a href="https://twitter.com/intent/tweet?text=E-commerce%20Platform%20Architecture%3A%20Building%20Scalable%20Online%20Commerce%20Solutions&url=https%3A%2F%2Fdvorson.github.io" target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-blue-500 transition-colors"> <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"> <path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"></path> </svg> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fdvorson.github.io" target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-blue-600 transition-colors"> <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"> <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"></path> </svg> </a> </div> </div> </footer> </article>  </main> <!-- Footer --> <footer class="bg-white border-t border-gray-100 py-8"> <div class="container mx-auto text-center"> <p class="text-gray-600 text-sm">
Â© 2025 Anton Dvorson. All rights reserved.
</p> <div class="mt-4 flex justify-center space-x-4"> <a href="https://github.com/dvorson" class="text-gray-400 hover:text-gray-700 transition-colors" target="_blank" rel="noopener noreferrer"> <i class="fab fa-github text-lg"></i> </a> <a href="https://linkedin.com/in/" class="text-gray-400 hover:text-gray-700 transition-colors" target="_blank" rel="noopener noreferrer"> <i class="fab fa-linkedin text-lg"></i> </a> <a href="https://twitter.com/" class="text-gray-400 hover:text-gray-700 transition-colors" target="_blank" rel="noopener noreferrer"> <i class="fab fa-twitter text-lg"></i> </a> </div> </div> </footer> </body></html>